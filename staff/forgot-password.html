<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Forgot Password - Staff</title>
    <meta http-equiv="refresh" content="0; url=forgot-password.php">
    <link rel="stylesheet" href="login.css">
</head>
<body class="staff-page">
    <script>
        window.location.href = 'forgot-password.php';
    </script>
    <p>Redirecting to <a href="forgot-password.php">forgot-password.php</a>...</p>
    <div class="auth-container">
        <div class="auth-sidebar">
            <div>
                <h2>Staff Portal</h2>
                <div class="logo-container">
                    <div class="logo-oval">
                        <img src="../images/16.png" class="sidebar-logo" alt="Lumière Logo">
                    </div>
                </div>
                <p>Reset your password using your phone number.</p>
            </div>
            <div>
                <p>Lumière Beauty Salon</p>
            </div>
        </div>

        <div class="auth-main">
            <form class="auth-form staff-theme" id="resetForm">
                <div class="form-header">
                    <h1>Forgot Password</h1>
                    <p>Enter your phone and new password</p>
                </div>

                <div id="error-alert" class="error-alert" style="display: none;"></div>
                <div id="success-alert" class="success-alert" style="display: none;"></div>

                <div class="form-group">
                    <div class="phone-wrapper">
                        <span class="input-prefix">+60</span>
                        <input type="tel"
                               class="form-control phone-input"
                               id="staffPhone"
                               placeholder="12 345 6789"
                               maxlength="13"
                               pattern="[1-9][0-9]*"
                               title="Numbers only, first digit cannot be 0."
                               required>
                    </div>
                </div>

                <div class="form-group">
                    <div class="input-wrapper">
                        <img src="../images/75.png" class="input-icon" alt="Lock">
                        <input type="password" class="form-control indent-icon" id="newPass" placeholder="New Password" required>
                    </div>
                </div>

                <div class="form-group">
                    <div class="input-wrapper">
                        <img src="../images/75.png" class="input-icon" alt="Lock">
                        <input type="password" class="form-control indent-icon" id="confirmPass" placeholder="Confirm Password" required>
                    </div>
                </div>

                <button type="submit" class="submit-btn">RESET PASSWORD</button>

                <div class="switch-form">
                    <a href="login.html">Back to Login</a>
                </div>

            </form>
        </div>
    </div>

    <script>
        document.getElementById('resetForm').addEventListener('submit', function(e) {
            e.preventDefault();
            handleReset();
        });

        function showMsg(id, msg) {
            const el = document.getElementById(id);
            el.textContent = msg;
            el.style.display = 'block';
        }

        function clearMsgs() {
            document.getElementById('error-alert').style.display = 'none';
            document.getElementById('success-alert').style.display = 'none';
        }

        // Normalize phone: strip spaces, no leading 0, ensure +60
        function normalizePhone(raw) {
            let v = raw.replace(/\s+/g, '');
            if (!v.startsWith('+60')) {
                v = v.replace(/^0+/, '');
                v = '+60' + v;
            }
            return v;
        }

        function handleReset() {
            clearMsgs();
            const phoneRaw = document.getElementById('staffPhone').value.trim();
            const pass = document.getElementById('newPass').value.trim();
            const confirm = document.getElementById('confirmPass').value.trim();

            if (!phoneRaw || !pass || !confirm) {
                showMsg('error-alert', 'Please fill in all fields.');
                return;
            }
            if (pass !== confirm) {
                showMsg('error-alert', 'Passwords do not match.');
                return;
            }
            if (pass.length < 8) {
                showMsg('error-alert', 'Password must be at least 8 characters.');
                return;
            }

            const phone = normalizePhone(phoneRaw);

            const formData = new FormData();
            formData.append('phone', phone);
            formData.append('password', pass);

            fetch('forgot-password.php', {
                method: 'POST',
                body: formData
            })
            .then(res => {
                const ct = res.headers.get('content-type');
                if (!ct || !ct.includes('application/json')) {
                    return res.text().then(t => { throw new Error(t); });
                }
                return res.json();
            })
            .then(data => {
                if (data.success) {
                    showMsg('success-alert', 'Password reset successfully. You can now login.');
                    document.getElementById('resetForm').reset();
                } else {
                    showMsg('error-alert', data.error || 'Reset failed.');
                }
            })
            .catch(err => {
                console.error(err);
                showMsg('error-alert', 'System error. Please try again.');
            });
        }
    </script>
</body>
</html>

