# Sustainability Analytics Dashboard - Technical Plan

## Context

Implement a complete Sustainability Analytics Dashboard at `admin/analytics/sustainability.php` that monitors operational efficiency and staff utilization for ESG reporting. The dashboard provides month/year filtering, 6 aggregate metric cards, staff-level utilization breakdown table, and optimization insights with actionable recommendations.

**Design Aesthetic**: Lumi√®re minimal, classy, card-based layout with clean white cards, soft shadows, Font Awesome v6 icons. Responsive grid system (3 columns desktop, 2 tablet, 1 mobile).

**Database**: Uses existing `salon.sql` schema. Column names verified from existing codebase: `staff_schedule.work_date` (not `date`), `booking_service.quoted_duration_minutes` and `quoted_cleanup_minutes` (not `quoted_duration`/`cleanup_time`), `staff.staff_email` (not `staff_id`).

---

## Files to Modify

### 1. `admin/analytics/sustainability.php`

**Current State**: Basic implementation exists with different structure. Needs complete rewrite to match requirements.

**Changes Required**:

1. **Authentication & Setup** (lines 1-13)
   - Include `../includes/auth_check.php` and call `requireAdminAuth()` (existing pattern)
   - Set `$page_title = 'Sustainability Analytics'` and `$base_path = '../..'` (already set)
   - Include `../../config/db_connect.php` and use `getDBConnection()` (already included)

2. **Month/Year Filter Logic** (new section after line 13)
   - Read `$_GET['month']` and `$_GET['year']` parameters
   - Validate: month must be numeric 01-12, year must be numeric 2020-2030
   - Default to current month/year if not set or invalid
   - Store validated values in `$selected_month` (2-digit string) and `$selected_year` (4-digit integer)
   - Apply to ALL subsequent queries via prepared statement parameters

3. **Aggregate Metrics Calculation** (replace lines 15-57)

   **Card 1: Total Active Staff**
   ```sql
   SELECT COUNT(*) as count 
   FROM Staff 
   WHERE is_active = 1
   ```
   - No date filter needed (current active count)
   - Store in `$total_active_staff`

   **Card 2: Services Delivered**
   ```sql
   SELECT COUNT(*) as count 
   FROM Booking 
   WHERE status IN ('confirmed', 'completed') 
   AND MONTH(booking_date) = ? 
   AND YEAR(booking_date) = ?
   ```
   - Use prepared statement with `$selected_month` and `$selected_year` as parameters
   - Store in `$services_delivered`

   **Card 3: Total Scheduled Hours (Capacity)**
   ```sql
   SELECT SUM(TIME_TO_SEC(TIMEDIFF(end_time, start_time))) / 3600 as total_hours
   FROM Staff_Schedule 
   WHERE MONTH(work_date) = ? 
   AND YEAR(work_date) = ?
   ```
   - Use prepared statement with month/year parameters
   - Format result to 2 decimal places: `number_format($value, 2)`
   - Store in `$total_scheduled_hours`

   **Card 4: Booked Hours (Utilized Time)**
   ```sql
   SELECT SUM((quoted_duration_minutes + quoted_cleanup_minutes)) / 60 as total_hours
   FROM Booking_Service bs
   JOIN Booking b ON bs.booking_id = b.booking_id
   WHERE b.status IN ('completed', 'confirmed')
   AND MONTH(b.booking_date) = ? 
   AND YEAR(b.booking_date) = ?
   ```
   - Use prepared statement with month/year parameters
   - Convert minutes to hours (divide by 60), format to 2 decimals
   - Store in `$total_booked_hours`

   **Card 5: Idle Hours**
   - Calculation: `$idle_hours = $total_scheduled_hours - $total_booked_hours`
   - Format to 2 decimal places
   - Store in `$idle_hours`
   - Flag for red display if `$idle_hours > ($total_scheduled_hours * 0.5)`

   **Card 6: Global Utilization Rate**
   - Calculation: `$utilization_rate = ($total_scheduled_hours > 0) ? ($total_booked_hours / $total_scheduled_hours) * 100 : 0`
   - Format: `number_format($utilization_rate, 2) . '%'`
   - Store in `$global_utilization_rate`
   - Determine progress bar color: Green if > 75%, Orange if < 60%, Blue otherwise

4. **Staff Breakdown Table** (new section)

   **Query Structure**:
   ```sql
   SELECT 
       st.staff_email,
       st.first_name,
       st.last_name,
       COALESCE(SUM(TIMESTAMPDIFF(MINUTE, ss.start_time, ss.end_time) / 60), 0) as scheduled_hours,
       COALESCE(SUM((bs.quoted_duration_minutes + bs.quoted_cleanup_minutes) / 60), 0) as booked_hours
   FROM Staff st
   LEFT JOIN Staff_Schedule ss ON st.staff_email = ss.staff_email 
       AND MONTH(ss.work_date) = ? 
       AND YEAR(ss.work_date) = ?
   LEFT JOIN Booking_Service bs ON st.staff_email = bs.staff_email
   LEFT JOIN Booking b ON bs.booking_id = b.booking_id 
       AND MONTH(b.booking_date) = ? 
       AND YEAR(b.booking_date) = ?
       AND b.status IN ('completed', 'confirmed')
   WHERE st.is_active = 1
   GROUP BY st.staff_email, st.first_name, st.last_name
   ORDER BY booked_hours DESC, scheduled_hours DESC
   ```

   **Processing Logic**:
   - Loop through query results
   - For each staff: calculate `$idle_hours = $scheduled_hours - $booked_hours`
   - Calculate `$utilization = ($scheduled_hours > 0) ? ($booked_hours / $scheduled_hours) * 100 : 0`
   - Store in array: `$staff_breakdown[] = ['name' => $first_name . ' ' . $last_name, 'scheduled' => ..., 'booked' => ..., 'idle' => ..., 'utilization' => ...]`
   - Sort array by utilization % descending: `usort($staff_breakdown, function($a, $b) { return $b['utilization'] <=> $a['utilization']; })`

   **Table Display Requirements**:
   - Columns: Staff Member, Scheduled (h), Booked (h), Idle (h), Utilization
   - Idle hours displayed in red if > 4 hours
   - Utilization: Progress bar + percentage text
   - Progress bar colors: Green (>80%), Orange (<60%), Blue (60-80%)

5. **Optimization Insights Logic** (new section)

   **Top Performer**:
   - From sorted `$staff_breakdown` array, find first element where `scheduled > 0`
   - Generate message: `"Efficiency Win: [Name] maintains [X]% utilization. Consider prioritizing high-value bookings for them."`
   - Store in `$top_performer_message`

   **Lowest Performer**:
   - From sorted `$staff_breakdown` array, find last element where `scheduled > 0`
   - Generate message: `"Opportunity: [Name] has [X] idle hours. Consider adjusting their roster or running a promo for their specialty."`
   - Store in `$lowest_performer_message`

   **Smart Suggestion** (based on Global Utilization):
   - If `$global_utilization_rate < 50%`: `"Consider reducing shifts or cross-training staff."`
   - If `$global_utilization_rate >= 50% && <= 90%`: `"Balanced efficiency. Maintain current scheduling."`
   - If `$global_utilization_rate > 90%`: `"High utilization. Consider hiring help to prevent burnout."`
   - Store in `$smart_suggestion`

6. **HTML Output Structure** (replace lines 66-246)

   **Header Section**:
   ```html
   <div class="analytics-header">
       <div>
           <h1 class="analytics-title">Sustainability Analytics</h1>
           <p class="analytics-subtitle">Monitor operational efficiency and staff utilization for ESG reporting</p>
       </div>
       <form method="GET" action="" class="date-filter-form">
           <select name="month" id="month-select">
               <!-- Options 01-12, selected value = $selected_month -->
           </select>
           <select name="year" id="year-select">
               <!-- Options 2020-2030, selected value = $selected_year -->
           </select>
           <button type="submit" class="btn btn-primary">Apply</button>
       </form>
   </div>
   ```

   **Top Grid - 6 Metrics Cards**:
   - Grid layout: `display: grid; grid-template-columns: repeat(3, 1fr);` (desktop)
   - Each card structure:
     ```html
     <div class="metric-card">
         <div class="metric-icon">[Font Awesome icon]</div>
         <div class="metric-value">[formatted value]</div>
         <div class="metric-label">[label]</div>
     </div>
     ```
   - Card 1: Icon `fa-users`, value `$total_active_staff`, label "Active Staff"
   - Card 2: Icon `fa-check-circle`, value `$services_delivered`, label "Services Delivered"
   - Card 3: Icon `fa-calendar-alt`, value `$total_scheduled_hours . 'h'`, label "Scheduled Hours"
   - Card 4: Icon `fa-clock`, value `$total_booked_hours . 'h'`, label "Booked Hours"
   - Card 5: Icon `fa-hourglass-half`, value `$idle_hours . 'h'`, label "Idle Hours" (red if > 50% of capacity)
   - Card 6: Icon `fa-percentage`, value `$global_utilization_rate . '%'`, label "Utilization Rate" (with progress bar)

   **Middle Section - Staff Breakdown Table**:
   ```html
   <div class="staff-breakdown-section">
       <h2 class="section-title">Staff Utilization Breakdown</h2>
       <div class="table-responsive">
           <table class="staff-table">
               <thead>
                   <tr>
                       <th>Staff Member</th>
                       <th>Scheduled (h)</th>
                       <th>Booked (h)</th>
                       <th>Idle (h)</th>
                       <th>Utilization</th>
                   </tr>
               </thead>
               <tbody>
                   <!-- Loop through $staff_breakdown array -->
               </tbody>
           </table>
       </div>
   </div>
   ```

   **Bottom Section - Optimization Insights**:
   ```html
   <div class="insights-section">
       <div class="insights-grid">
           <div class="alert alert-success">
               <h4>üèÜ Efficiency Win</h4>
               <p><?php echo htmlspecialchars($top_performer_message); ?></p>
           </div>
           <div class="alert alert-warning">
               <h4>üí° Optimization Opportunity</h4>
               <p><?php echo htmlspecialchars($lowest_performer_message); ?></p>
           </div>
       </div>
       <div class="alert alert-info">
           <h4>üìà Efficiency Analysis</h4>
           <p><?php echo htmlspecialchars($smart_suggestion); ?></p>
       </div>
   </div>
   ```

7. **CSS Styling** (replace lines 253-440)

   Include inline `<style>` block with:
   - Grid layout for metric cards (3 columns desktop, 2 tablet, 1 mobile)
   - Table responsiveness (horizontal scroll on mobile)
   - Progress bar styling (height 8px, border-radius 4px, colors based on thresholds)
   - Alert box styling (Bootstrap-like classes: alert-success, alert-warning, alert-info)
   - Mobile breakpoints (@media queries for 768px and 1024px)
   - Color coding: red text for idle hours > 4h or > 50% capacity, green/orange/blue for utilization progress bars

8. **Error Handling** (add try-catch blocks)

   - Wrap all database operations in try-catch blocks
   - Handle division by zero for utilization calculations (already handled in logic)
   - Display friendly message if no data for selected month: "No data available for selected period"
   - Log errors using `error_log()` but don't display technical details to user

---

## Algorithm Details

### Timeframe Filter Validation

```
1. Read $_GET['month'] and $_GET['year']
2. Validate month:
   - If not set or empty: use current month
   - If set: check if numeric and between 1-12
   - If invalid: use current month
   - Format as 2-digit string with leading zero (01-12)
3. Validate year:
   - If not set or empty: use current year
   - If set: check if numeric and between 2020-2030
   - If invalid: use current year
4. Store in $selected_month (string) and $selected_year (integer)
5. Use in all SQL queries via prepared statement parameters
```

### Utilization Rate Calculation

```
For Global Utilization:
1. Execute query for scheduled_hours (sum of time differences from Staff_Schedule)
2. Execute query for booked_hours (sum of durations from Booking_Service)
3. If scheduled_hours == 0:
   - Set utilization_rate = 0 (avoid division by zero)
4. Else:
   - utilization_rate = (booked_hours / scheduled_hours) * 100
   - Format to 2 decimal places
5. Determine progress bar color:
   - If utilization_rate > 75%: green
   - If utilization_rate < 60%: orange
   - Else: blue
```

### Staff Breakdown Calculation and Sorting

```
1. Execute single query with LEFT JOINs to get all active staff with their scheduled/booked hours
2. Loop through query results:
   a. Calculate idle_hours = scheduled_hours - booked_hours
   b. Calculate utilization = (booked_hours / scheduled_hours) * 100 if scheduled_hours > 0, else 0
   c. Store in array: ['name' => ..., 'scheduled' => ..., 'booked' => ..., 'idle' => ..., 'utilization' => ...]
3. Sort array by utilization descending:
   usort($staff_breakdown, function($a, $b) { 
       return $b['utilization'] <=> $a['utilization']; 
   })
4. Display sorted results in table
```

### Optimization Insights Generation

```
1. From sorted $staff_breakdown array:
   - Top Performer: First element where scheduled_hours > 0
     - Message: "Efficiency Win: [Name] maintains [X]% utilization. Consider prioritizing high-value bookings for them."
   - Lowest Performer: Last element where scheduled_hours > 0
     - Message: "Opportunity: [Name] has [X] idle hours. Consider adjusting their roster or running a promo for their specialty."

2. From global utilization_rate:
   - If < 50%: "Consider reducing shifts or cross-training staff."
   - If 50-90%: "Balanced efficiency. Maintain current scheduling."
   - If > 90%: "High utilization. Consider hiring help to prevent burnout."
```

---

## Database Schema Reference

**Verified Column Names** (from existing codebase):

- `Staff` table: `staff_email` (PRIMARY KEY), `first_name`, `last_name`, `is_active`
- `Staff_Schedule` table: `staff_email` (FK), `work_date` (DATE), `start_time` (TIME), `end_time` (TIME), `status`
- `Booking` table: `booking_id` (PRIMARY KEY), `booking_date` (DATE), `status` (ENUM: 'confirmed', 'completed', 'cancelled')
- `Booking_Service` table: `booking_service_id` (PRIMARY KEY), `booking_id` (FK), `staff_email` (FK), `quoted_duration_minutes` (INT), `quoted_cleanup_minutes` (INT)

**Note**: User requirements mention `staff_id`, `staff_schedule.date`, and `booking_service.quoted_duration`/`cleanup_time`, but actual schema uses `staff_email`, `work_date`, and `quoted_duration_minutes`/`quoted_cleanup_minutes`. Implementation must use actual column names.

---

## Security Requirements

1. **Prepared Statements**: All SQL queries must use prepared statements with parameter binding (MySQLi `prepare()` and `bind_param()`)
2. **Input Validation**: Validate and sanitize month/year GET parameters (numeric, range check)
3. **Output Escaping**: Escape all database values when displaying: `htmlspecialchars($value, ENT_QUOTES, 'UTF-8')`
4. **Authentication**: Page must require admin authentication via `requireAdminAuth()` (already in place)

---

## Performance Considerations

1. **Query Optimization**: Use single query with LEFT JOINs and GROUP BY for staff breakdown instead of per-staff queries (N+1 problem)
2. **Index Usage**: Existing indexes on `Staff_Schedule.work_date`, `Booking.booking_date`, and `Booking.status` should be utilized
3. **No Pagination Needed**: Staff list likely < 50 members

---

## Responsive Design Breakpoints

- **Desktop (>1024px)**: 3-column grid for metric cards, full table width
- **Tablet (768-1024px)**: 2-column grid for metric cards, table with horizontal scroll if needed
- **Mobile (<768px)**: 1-column grid for metric cards, table with horizontal scroll, stacked insights

---

## Files Reference

| File | Purpose | Status |
|------|---------|--------|
| `admin/analytics/sustainability.php` | Main dashboard page | Modify (complete rewrite) |
| `admin/includes/auth_check.php` | Authentication function `requireAdminAuth()` | Reference |
| `admin/includes/header.php` | Page header template | Include |
| `admin/includes/footer.php` | Page footer template | Include |
| `config/db_connect.php` | Database connection function `getDBConnection()` | Include |
| `api/admin/analytics/idle_hours.php` | Reference for column names and query patterns | Reference |

