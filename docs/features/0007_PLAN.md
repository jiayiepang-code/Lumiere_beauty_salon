# Sustainability Analytics Dashboard - Technical Plan

## Context

Implement a complete Sustainability Analytics Dashboard at `admin/analytics/sustainability.php` that monitors operational efficiency and staff utilization for ESG reporting. The dashboard provides month/year filtering, 6 aggregate metric cards, staff-level utilization breakdown table, and optimization insights with actionable recommendations.

**Design Aesthetic**: Lumière minimal, classy, card-based layout with clean white cards, soft shadows, custom SVG icons (Font Awesome v6 CDN included but not used for metric cards). Responsive grid system (3 columns desktop, 2 tablet, 1 mobile).

**Database**: Uses existing `salon.sql` schema. Column names verified from existing codebase: `staff_schedule.work_date` (not `date`), `booking_service.quoted_duration_minutes` and `quoted_cleanup_minutes` (not `quoted_duration`/`cleanup_time`), `staff.staff_email` (not `staff_id`).

---

## Files to Modify

### 1. `admin/analytics/sustainability.php`

**Current State**: Basic implementation exists with different structure. Needs complete rewrite to match requirements.

**Changes Required**:

1. **Authentication & Setup** (lines 1-13)

   - Include `../includes/auth_check.php` and call `requireAdminAuth()` (existing pattern)
   - Set `$page_title = 'Sustainability Analytics'` and `$base_path = '../..'` (already set)
   - Include `../../config/db_connect.php` and use `getDBConnection()` (already included)

2. **Month/Year Filter Logic** (new section after line 13)

   - Read `$_GET['month']` and `$_GET['year']` parameters
   - Validate month: must be numeric 01-12, default to current month if invalid
   - Build available years dynamically from database:
     ```sql
     SELECT DISTINCT YEAR(booking_date) AS year FROM Booking WHERE booking_date IS NOT NULL
     UNION
     SELECT DISTINCT YEAR(work_date) AS year FROM Staff_Schedule WHERE work_date IS NOT NULL
     ORDER BY year DESC
     ```
   - Default to current year if available, otherwise first available year
   - Store validated values in `$selected_month` (2-digit string) and `$selected_year` (4-digit integer)
   - Apply to ALL subsequent queries via prepared statement parameters

3. **Aggregate Metrics Calculation** (replace lines 15-57)

   **Card 1: Total Active Staff**

   ```sql
   SELECT COUNT(*) as count
   FROM Staff
   WHERE is_active = 1
   ```

   - No date filter needed (current active count)
   - Store in `$total_active_staff`

   **Card 2: Services Delivered**

   ```sql
   SELECT COUNT(*) as count
   FROM Booking
   WHERE status IN ('confirmed', 'completed')
   AND MONTH(booking_date) = ?
   AND YEAR(booking_date) = ?
   ```

   - Use prepared statement with `$selected_month` and `$selected_year` as parameters
   - Store in `$services_delivered`

   **Card 3: Total Scheduled Hours (Capacity)**

   ```sql
   SELECT SUM(TIME_TO_SEC(TIMEDIFF(end_time, start_time))) / 3600 as total_hours
   FROM Staff_Schedule
   WHERE MONTH(work_date) = ?
   AND YEAR(work_date) = ?
   ```

   - Use prepared statement with month/year parameters
   - Format result to 2 decimal places: `number_format($value, 2)`
   - Store in `$total_scheduled_hours`

   **Card 4: Booked Hours (Utilized Time)**

   ```sql
   SELECT SUM((quoted_duration_minutes + quoted_cleanup_minutes)) / 60 as total_hours
   FROM Booking_Service bs
   JOIN Booking b ON bs.booking_id = b.booking_id
   WHERE b.status IN ('completed', 'confirmed')
   AND MONTH(b.booking_date) = ?
   AND YEAR(b.booking_date) = ?
   ```

   - Use prepared statement with month/year parameters
   - Convert minutes to hours (divide by 60), format to 2 decimals
   - Store in `$total_booked_hours`

   **Card 5: Idle Hours**

   - Calculation: `$idle_hours = $total_scheduled_hours - $total_booked_hours`
   - Format to 2 decimal places
   - Store in `$idle_hours`
   - Flag for red display if `$idle_hours > ($total_scheduled_hours * 0.5)`

   **Card 6: Global Utilization Rate**

   - Calculation: `$utilization_rate = ($total_scheduled_hours > 0) ? ($total_booked_hours / $total_scheduled_hours) * 100 : 0`
   - Format: `number_format($utilization_rate, 2) . '%'`
   - Store in `$global_utilization_rate`
   - Determine progress bar color: Green if > 75%, Orange if < 60%, Blue otherwise

4. **Staff Breakdown Table** (new section)

   **Query Structure**:

   ```sql
   SELECT
       st.staff_email,
       st.first_name,
       st.last_name,
       COALESCE(SUM(TIMESTAMPDIFF(MINUTE, ss.start_time, ss.end_time) / 60), 0) as scheduled_hours,
       COALESCE(SUM((bs.quoted_duration_minutes + bs.quoted_cleanup_minutes) / 60), 0) as booked_hours
   FROM Staff st
   LEFT JOIN Staff_Schedule ss ON st.staff_email = ss.staff_email
       AND MONTH(ss.work_date) = ?
       AND YEAR(ss.work_date) = ?
   LEFT JOIN Booking_Service bs ON st.staff_email = bs.staff_email
   LEFT JOIN Booking b ON bs.booking_id = b.booking_id
       AND MONTH(b.booking_date) = ?
       AND YEAR(b.booking_date) = ?
       AND b.status IN ('completed', 'confirmed')
   WHERE st.is_active = 1
   GROUP BY st.staff_email, st.first_name, st.last_name
   ORDER BY booked_hours DESC, scheduled_hours DESC
   ```

   **Processing Logic**:

   - Loop through query results
   - For each staff: calculate `$idle_hours = $scheduled_hours - $booked_hours`
   - Calculate `$utilization = ($scheduled_hours > 0) ? ($booked_hours / $scheduled_hours) * 100 : 0`
   - Store in array: `$staff_breakdown[] = ['name' => $first_name . ' ' . $last_name, 'scheduled' => ..., 'booked' => ..., 'idle' => ..., 'utilization' => ...]`
   - Sort array by utilization % descending: `usort($staff_breakdown, function($a, $b) { return $b['utilization'] <=> $a['utilization']; })`

   **Table Display Requirements**:

   - Columns: Staff Member, Scheduled (h), Booked (h), Idle (h), Utilization
   - Filter out admin role: `WHERE st.is_active = 1 AND st.role != 'admin'`
   - Idle hours displayed in red if > 4 hours
   - Utilization: Progress bar + percentage text
   - Progress bar colors: Green (>80%), Orange (<60%), Blue (60-80%)
   - Sort by utilization % descending in PHP (not SQL ORDER BY)

5. **Optimization Insights Logic** (new section)

   **Top Performer**:

   - From sorted `$staff_breakdown` array, find first element where `scheduled > 0`
   - Generate message: `"[Name] maintains [X]% utilization. Consider prioritizing high-value bookings for them."`
   - Store in `$top_performer_message`
   - Display in alert with header: `<h4>Efficiency Win</h4>` and Font Awesome star icon

   **Lowest Performer**:

   - From sorted `$staff_breakdown` array, find last element where `scheduled > 0`
   - Generate message: `"[Name] has [X] idle hours. Consider adjusting their roster or running a promo for their specialty."`
   - Store in `$lowest_performer_message`
   - Display in alert with header: `<h4>Optimization Opportunity</h4>` and Font Awesome lightbulb icon

   **Smart Suggestion** (based on Global Utilization):

   - If `$global_utilization_rate < 50%`: `"Consider reducing shifts or cross-training staff."`
   - If `$global_utilization_rate >= 50% && <= 90%`: `"Balanced efficiency. Maintain current scheduling."`
   - If `$global_utilization_rate > 90%`: `"High utilization. Consider hiring help to prevent burnout."`
   - Store in `$smart_suggestion`

6. **HTML Output Structure** (replace lines 66-246)

   **Header Section**:

   ```html
   <div class="analytics-header">
     <div>
       <h1 class="analytics-title">Sustainability Analytics</h1>
       <p class="analytics-subtitle">
         Monitor operational efficiency and staff utilization for ESG reporting
         (Monthly only)
       </p>
     </div>
     <form method="GET" action="" class="date-filter-form">
       <select name="month" id="month-select" class="form-control">
         <!-- Options 01-12 with month names, selected value = $selected_month -->
       </select>
       <select name="year" id="year-select" class="form-control">
         <!-- Options from $available_years array, selected value = $selected_year -->
       </select>
       <button type="submit" class="btn btn-primary">Apply</button>
     </form>
   </div>
   ```

   **Top Grid - 6 Metrics Cards**:

   - Grid layout: `display: grid; grid-template-columns: repeat(3, 1fr);` (desktop)
   - Each card structure:
     ```html
     <div class="metric-card">
       <div class="card-header">
         <div class="metric-icon [color]-icon">
           <!-- Custom SVG icon -->
         </div>
         <div class="card-info-btn" data-tooltip="[tooltip text]">
           <!-- Info icon SVG -->
         </div>
       </div>
       <div class="metric-value">[formatted value]</div>
       <div class="metric-label">[label]</div>
       <div class="metric-description">[description]</div>
       <!-- Card 6 only: utilization progress bar -->
     </div>
     ```
   - Card 1: SVG users icon (blue), value `$total_active_staff`, label "Active Staff", description "Total staff available for bookings"
   - Card 2: SVG checkmark icon (green), value `$services_delivered`, label "Services Delivered", description "Completed & confirmed bookings"
   - Card 3: SVG calendar icon (amber), value `number_format($total_scheduled_hours, 2) . 'h'`, label "Scheduled Hours", description "Total staff capacity planned"
   - Card 4: SVG clock icon (lime), value `number_format($total_booked_hours, 2) . 'h'`, label "Booked Hours", description "Staff hours actually used"
   - Card 5: SVG clock icon (orange), value `number_format($idle_hours, 2) . 'h'`, label "Idle Hours", description "Wasted capacity potential" (red text if > 50% of capacity)
   - Card 6: SVG pie chart icon (brown), value `number_format($global_utilization_rate, 2) . '%'`, label "Utilization Rate", description "Staff productivity efficiency" (with progress bar)

   **Optimization Insights Section** (displayed BEFORE staff breakdown):

   ```html
   <div class="insights-section">
     <div class="insights-grid">
       <div class="alert alert-success">
         <div class="alert-header">
           <i class="fas fa-star"></i>
           <h4>Efficiency Win</h4>
         </div>
         <p><?php echo htmlspecialchars($top_performer_message); ?></p>
       </div>
       <div class="alert alert-warning">
         <div class="alert-header">
           <i class="fas fa-lightbulb"></i>
           <h4>Optimization Opportunity</h4>
         </div>
         <p><?php echo htmlspecialchars($lowest_performer_message); ?></p>
       </div>
     </div>
     <div class="alert alert-info">
       <div class="alert-header">
         <i class="fas fa-chart-line"></i>
         <h4>Efficiency Analysis</h4>
       </div>
       <p><?php echo htmlspecialchars($smart_suggestion); ?></p>
     </div>
   </div>
   ```

   **Middle Section - Staff Breakdown Table**:

   ```html
   <div class="staff-breakdown-section">
     <h2 class="section-title">Staff Utilization Breakdown</h2>
     <div class="table-responsive">
       <table class="staff-table">
         <thead>
           <tr>
             <th>Staff Member</th>
             <th>Scheduled (h)</th>
             <th>Booked (h)</th>
             <th>Idle (h)</th>
             <th>Utilization</th>
           </tr>
         </thead>
         <tbody>
           <!-- Loop through $staff_breakdown array -->
           <!-- Show empty message if no data -->
         </tbody>
       </table>
     </div>
   </div>
   ```

   **Bottom Section - Staff Work Schedule Summary** (NEW - not in original plan):

   ```html
   <div class="staff-schedule-section" id="staff-work-schedule">
     <div class="section-header">
       <h2 class="section-title">
         Staff Work Schedule -
         <?php echo $current_month_display; ?>
       </h2>
       <a
         href="../calendar/master.php?view=month&start_date=...&end_date=..."
         class="btn btn-secondary"
       >
         <i class="fas fa-calendar"></i> View Full Schedule in Master Calendar
       </a>
     </div>
     <div class="schedule-summary-table-wrapper">
       <table class="schedule-summary-table">
         <thead>
           <tr>
             <th>Staff Member</th>
             <th>Total Scheduled Hours</th>
             <th>Days Worked</th>
             <th>Leave Days</th>
             <th>Average Hours/Day</th>
             <th>Actions</th>
           </tr>
         </thead>
         <tbody>
           <!-- Loop through $schedule_summary array -->
         </tbody>
       </table>
     </div>
   </div>
   ```

   **Staff Schedule Summary Logic** (lines 221-252):

   - Loop through `$staff_breakdown` array
   - For each staff member, query schedule details:
     ```sql
     SELECT
         COUNT(DISTINCT work_date) as days_worked,
         COUNT(DISTINCT CASE WHEN status = 'leave' THEN work_date END) as leave_days
     FROM Staff_Schedule
     WHERE staff_email = ?
     AND MONTH(work_date) = ?
     AND YEAR(work_date) = ?
     ```
   - Calculate average hours per day: `avg_hours = scheduled_hours / days_worked` (if days_worked > 0)
   - Store in `$schedule_summary` array with: name, email, scheduled, days_worked, leave_days, avg_hours
   - **Note**: This uses N+1 query pattern (could be optimized to single query with GROUP BY)

7. **CSS Styling** (inline `<style>` block, ~658 lines)

   Include inline `<style>` block with:

   - Grid layout for metric cards (3 columns desktop, 2 tablet, 1 mobile)
   - Metric card styling with hover effects, card headers, info buttons with tooltips
   - Icon styling with color-coded backgrounds (blue, green, amber, lime, orange, brown)
   - Table responsiveness (horizontal scroll on mobile)
   - Progress bar styling (height 6px for main, 6px for table cells, border-radius 3-4px, colors based on thresholds)
   - Alert box styling with headers, icons, and animations (alert-success, alert-warning, alert-info, alert-danger)
   - Staff schedule section styling with summary table
   - Mobile breakpoints (@media queries for 768px and 1024px)
   - Color coding: red text for idle hours > 4h or > 50% capacity, green/orange/blue for utilization progress bars
   - Tooltip styling for card info buttons (CSS ::after and ::before pseudo-elements)

8. **Error Handling** (add try-catch blocks)

   - Wrap all database operations in try-catch blocks
   - Handle division by zero for utilization calculations (already handled in logic)
   - Display friendly message if no data for selected month: "No data available for selected period"
   - Log errors using `error_log()` but don't display technical details to user

9. **PDF Export Feature** (NEW)

   **Export Button** (after line 317, in analytics-header div):

   - Add export button next to date filter form:
     ```html
     <button type="button" id="export-esg-pdf" class="btn btn-secondary">
       <i class="fas fa-file-pdf"></i> Export ESG Report
     </button>
     ```
   - Include JavaScript file: `<script src="sustainability.js"></script>` before footer

   **PDF Export API Endpoint** (NEW FILE: `api/admin/analytics/export_esg_pdf.php`):

   - Accept `month` and `year` GET parameters
   - Require admin authentication via `requireAdminAuth()`
   - Fetch all sustainability data using same queries as main page
   - Generate PDF using TCPDF library (if available) or fallback to text file
   - Include company logo from `images/16.png`
   - Include company information:
     - Address: "No. 10, Ground Floor Block B, Phase 2, Jln Lintas, Kolam Centre, 88300 Kota Kinabalu, Sabah"
     - Email: "Lumiere@gmail.com"
     - Phone: "012 345 6789 / 088 978 8977"
   - PDF structure:
     - Header with logo and company info
     - Report title: "ESG Sustainability Report"
     - Month Year (e.g., "December 2025")
     - Generated on: [Date Time]
     - Key Metrics section (all 6 metric cards data)
     - Staff Utilization Breakdown table
     - Footer with page numbers
   - Output filename: `ESG_Report_YYYY_MM.pdf`

   **JavaScript Export Function** (`admin/analytics/sustainability.js`):

   - Initialize export button on DOMContentLoaded
   - `exportESGReport()` function:
     - Get month and year from select elements
     - Show loading state on button
     - Call API endpoint: `../../api/admin/analytics/export_esg_pdf.php?month={month}&year={year}`
     - Handle PDF blob download
     - Show success/error messages (using SweetAlert2 if available)
     - Restore button state after completion

   **PDF Library Setup**:

   - Option A: TCPDF (recommended)
     - Download from: https://github.com/tecnickcom/TCPDF
     - Place in `vendor/tecnickcom/tcpdf/` or `vendor/tcpdf/`
     - API will auto-detect and use if available
   - Option B: Fallback to text file if PDF library not installed
   - Requires PHP GD extension for image handling

---

## Algorithm Details

### Timeframe Filter Validation

```
1. Read $_GET['month'] and $_GET['year']
2. Validate month:
   - If not set or empty: use current month
   - If set: check if numeric and between 1-12
   - If invalid: use current month
   - Format as 2-digit string with leading zero (01-12)
3. Build available years from database:
   - Query Booking and Staff_Schedule tables for distinct years
   - Union results and order by year DESC
   - If no years found, use current year
4. Validate year:
   - If not set or empty: use current year (if available) or first available year
   - If set: check if numeric and exists in available_years array
   - If invalid: use current year (if available) or first available year
5. Store in $selected_month (string) and $selected_year (integer)
6. Use in all SQL queries via prepared statement parameters
```

### Utilization Rate Calculation

```
For Global Utilization:
1. Execute query for scheduled_hours (sum of time differences from Staff_Schedule)
2. Execute query for booked_hours (sum of durations from Booking_Service)
3. If scheduled_hours == 0:
   - Set utilization_rate = 0 (avoid division by zero)
4. Else:
   - utilization_rate = (booked_hours / scheduled_hours) * 100
   - Format to 2 decimal places
5. Determine progress bar color:
   - If utilization_rate > 75%: green
   - If utilization_rate < 60%: orange
   - Else: blue
```

### Staff Breakdown Calculation and Sorting

```
1. Execute single query with LEFT JOINs to get all active staff (excluding admin role) with their scheduled/booked hours
2. Loop through query results:
   a. Calculate idle_hours = scheduled_hours - booked_hours (prevent negative values)
   b. Calculate utilization = (booked_hours / scheduled_hours) * 100 if scheduled_hours > 0, else 0
   c. Escape name with htmlspecialchars for security
   d. Store in array: ['name' => ..., 'staff_email' => ..., 'scheduled' => ..., 'booked' => ..., 'idle' => ..., 'utilization' => ...]
3. Sort array by utilization descending in PHP:
   usort($staff_breakdown, function($a, $b) {
       return $b['utilization'] <=> $a['utilization'];
   })
4. Display sorted results in table
5. Additional: Query schedule summary for each staff (days worked, leave days, avg hours) - N+1 pattern
```

### Optimization Insights Generation

```
1. From sorted $staff_breakdown array:
   - Top Performer: First element where scheduled_hours > 0
     - Message: "[Name] maintains [X]% utilization. Consider prioritizing high-value bookings for them."
     - Displayed in alert-success with header "Efficiency Win" and star icon
   - Lowest Performer: Last element where scheduled_hours > 0
     - Message: "[Name] has [X] idle hours. Consider adjusting their roster or running a promo for their specialty."
     - Displayed in alert-warning with header "Optimization Opportunity" and lightbulb icon

2. From global utilization_rate:
   - If < 50%: "Consider reducing shifts or cross-training staff."
   - If 50-90%: "Balanced efficiency. Maintain current scheduling."
   - If > 90%: "High utilization. Consider hiring help to prevent burnout."
```

---

## Database Schema Reference

**Verified Column Names** (from existing codebase):

- `Staff` table: `staff_email` (PRIMARY KEY), `first_name`, `last_name`, `is_active`, `role` (used to filter out 'admin')
- `Staff_Schedule` table: `staff_email` (FK), `work_date` (DATE), `start_time` (TIME), `end_time` (TIME), `status` (ENUM: 'working', 'leave', etc.)
- `Booking` table: `booking_id` (PRIMARY KEY), `booking_date` (DATE), `status` (ENUM: 'confirmed', 'completed', 'cancelled', 'no-show', 'available')
- `Booking_Service` table: `booking_service_id` (PRIMARY KEY), `booking_id` (FK), `staff_email` (FK), `quoted_duration_minutes` (INT), `quoted_cleanup_minutes` (INT), `service_status` (ENUM: 'confirmed', 'completed', 'cancelled', 'no-show')

**Note**: User requirements mention `staff_id`, `staff_schedule.date`, and `booking_service.quoted_duration`/`cleanup_time`, but actual schema uses `staff_email`, `work_date`, and `quoted_duration_minutes`/`quoted_cleanup_minutes`. Implementation must use actual column names.

---

## Security Requirements

1. **Prepared Statements**: All SQL queries must use prepared statements with parameter binding (MySQLi `prepare()` and `bind_param()`)
2. **Input Validation**: Validate and sanitize month/year GET parameters (numeric, range check)
3. **Output Escaping**: Escape all database values when displaying: `htmlspecialchars($value, ENT_QUOTES, 'UTF-8')`
4. **Authentication**: Page must require admin authentication via `requireAdminAuth()` (already in place)

---

## Performance Considerations

1. **Query Optimization**: Use single query with LEFT JOINs and GROUP BY for staff breakdown instead of per-staff queries (N+1 problem)
2. **N+1 Query Issue**: Staff schedule summary section uses a loop query (lines 221-252) - could be optimized to single query with GROUP BY
3. **Index Usage**: Existing indexes on `Staff_Schedule.work_date`, `Booking.booking_date`, and `Booking.status` should be utilized
4. **No Pagination Needed**: Staff list likely < 50 members

---

## Responsive Design Breakpoints

- **Desktop (>1024px)**: 3-column grid for metric cards, full table width
- **Tablet (768-1024px)**: 2-column grid for metric cards, table with horizontal scroll if needed
- **Mobile (<768px)**: 1-column grid for metric cards, table with horizontal scroll, stacked insights

---

## Files Reference

| File                                     | Purpose                                          | Status                       |
| ---------------------------------------- | ------------------------------------------------ | ---------------------------- |
| `admin/analytics/sustainability.php`     | Main dashboard page                              | ✅ Implemented (1283+ lines) |
| `admin/analytics/sustainability.js`      | JavaScript for PDF export functionality          | ✅ Implemented               |
| `api/admin/analytics/export_esg_pdf.php` | PDF export API endpoint                          | ✅ Implemented               |
| `admin/includes/auth_check.php`          | Authentication function `requireAdminAuth()`     | Reference                    |
| `admin/includes/header.php`              | Page header template                             | Include                      |
| `admin/includes/footer.php`              | Page footer template                             | Include                      |
| `config/db_connect.php`                  | Database connection function `getDBConnection()` | Include                      |
| `api/admin/analytics/idle_hours.php`     | Reference for column names and query patterns    | Reference                    |
| `images/16.png`                          | Company logo for PDF header                      | Required                     |
