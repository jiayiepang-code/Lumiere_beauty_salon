# Automated Email Notification System - Technical Plan

## Context

Implement an automated email notification system for the booking module with two notification types:

1. **Instant Confirmation** - Sent immediately after a customer completes a booking
2. **24-Hour Reminder** - Sent one day before the booking date/time

The system uses **Native PHP with PHPMailer** (already configured via SMTP/Gmail) for robust email delivery.

---

## Existing Infrastructure

The project already has foundational email components in place:

| Component           | File                            | Status               |
| ------------------- | ------------------------------- | -------------------- |
| Email Service Class | `includes/EmailService.php`     | ✅ Implemented       |
| SMTP Configuration  | `config/email_config.php`       | ✅ Configured        |
| PHPMailer Library   | `PHPMailer/src/`                | ✅ Available         |
| Booking API         | `api/create_booking.php`        | ✅ Has email trigger |
| Cron Script         | `cron/send_reminder_emails.php` | ✅ Implemented       |

---

## Component 1: Email Template Management

### File: `includes/EmailService.php`

The `EmailService` class manages all email templates and sending logic:

```
EmailService
├── __construct()           → Initialize PHPMailer with SMTP config
├── configureSMTP()         → Set Gmail SMTP settings
├── sendConfirmationEmail() → Instant confirmation delivery
├── sendReminderEmail()     → 24-hour reminder delivery
├── getConfirmationTemplate()     → HTML confirmation template
├── getReminderTemplate()         → HTML reminder template
├── getConfirmationTextTemplate() → Plain text fallback
├── getReminderTextTemplate()     → Plain text fallback
└── formatDateTime()        → Convert MySQL datetime to readable format
```

### Template Data Structure

Both templates expect this data array:

```php
$emailData = [
    'booking_id'     => 'BK241213001',
    'customer_email' => 'customer@email.com',
    'customer_name'  => 'John Doe',
    'booking_date'   => '2025-12-14',        // MySQL DATE
    'start_time'     => '14:00:00',          // MySQL TIME
    'total_price'    => '150.00',            // Formatted
    'location'       => 'Hilltop, KK',       // From SALON_LOCATION constant
    'address'        => 'Full address...',   // From SALON_ADDRESS constant
    'phone'          => '+60 12 345 6789'    // From SALON_PHONE constant
];
```

### Template Design Features

- **Responsive HTML** with inline CSS (email client compatibility)
- **Plain text fallback** via `AltBody` for non-HTML clients
- **Branded gradient headers** (purple for confirmation, pink for reminder)
- **Clear booking details** with visual hierarchy
- **Action buttons** linking to booking management portal
- **Preparation tips** in reminder emails

---

## Component 2: Instant Confirmation Trigger

### File: `api/create_booking.php`

**Trigger Location:** Lines 55-75 (after successful booking insertion, before commit)

### Algorithm Flow

```
1. Validate booking data and authenticate user
2. Begin database transaction
3. Generate booking ID (format: BK + YYMMDD + sequence)
4. Calculate service duration and expected finish time
5. INSERT into booking table
6. INSERT into booking_service table (services + staff)
7. GET customer details (name, email)
8. ──► TRIGGER: Send confirmation email immediately
9. Queue reminder email (INSERT into email_queue)
10. COMMIT transaction
11. Return success response with booking_id
```

### Key Implementation Details

```php
// Line 55-75 in create_booking.php
$emailService = new EmailService();
$emailData = [
    'booking_id' => $booking_id,
    'customer_email' => $customer['customer_email'],
    'customer_name' => $customer['first_name'] . ' ' . $customer['last_name'],
    // ... other fields
];

$emailResult = $emailService->sendConfirmationEmail($emailData);

// Non-blocking: Log error but don't fail booking
if (!$emailResult['success']) {
    error_log("Confirmation email failed for booking $booking_id: " . $emailResult['error']);
}
```

**Error Handling Strategy:** Email failures are logged but do not rollback the booking transaction. The booking is still valid even if the email fails.

---

## Component 3: 24-Hour Reminder System (Cron Job)

### Database: `email_queue` Table Schema

```sql
CREATE TABLE email_queue (
    queue_id INT AUTO_INCREMENT PRIMARY KEY,
    booking_id VARCHAR(20) NOT NULL,
    email_type ENUM('confirmation', 'reminder') NOT NULL,
    recipient_email VARCHAR(100) NOT NULL,
    scheduled_at DATETIME NOT NULL,
    status ENUM('pending', 'sent', 'failed') DEFAULT 'pending',
    sent_at DATETIME NULL,
    retry_count INT DEFAULT 0,
    error_message TEXT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,

    INDEX idx_email_queue_scheduled (scheduled_at, status),
    INDEX idx_email_queue_type_status (email_type, status),
    FOREIGN KEY (booking_id) REFERENCES booking(booking_id)
);
```

### Queue Population (in `create_booking.php`)

When a booking is created, the reminder is scheduled:

```php
function calculateReminderTime($bookingDate, $startTime) {
    // Booking datetime - 24 hours
    $bookingDateTime = new DateTime("$bookingDate $startTime");
    $reminderDateTime = clone $bookingDateTime;
    $reminderDateTime->modify('-24 hours');
    return $reminderDateTime->format('Y-m-d H:i:s');
}

// Insert into queue
$stmt = $db->prepare("
    INSERT INTO email_queue (
        booking_id, email_type, recipient_email, scheduled_at
    ) VALUES (?, 'reminder', ?, ?)
");
$stmt->execute([$booking_id, $customer['customer_email'], $reminderTime]);
```

### File: `cron/send_reminder_emails.php`

**Recommended Cron Schedule:** Every hour (for flexibility)

```bash
0 * * * * /usr/bin/php /path/to/cron/send_reminder_emails.php >> /var/log/email_reminders.log 2>&1
```

**Alternative for 09:00 Daily Run:**

```bash
0 9 * * * /usr/bin/php /path/to/cron/send_reminder_emails.php >> /var/log/email_reminders.log 2>&1
```

### Core MySQL Query for Finding Due Reminders

```sql
SELECT
    eq.queue_id,
    eq.booking_id,
    eq.recipient_email,
    b.booking_date,
    b.start_time,
    b.total_price,
    CONCAT(c.first_name, ' ', c.last_name) as customer_name
FROM email_queue eq
JOIN booking b ON eq.booking_id = b.booking_id
JOIN customer c ON b.customer_email = c.customer_email
WHERE eq.email_type = 'reminder'
  AND eq.status = 'pending'
  AND eq.scheduled_at <= NOW()
  AND b.status = 'confirmed'
ORDER BY eq.scheduled_at ASC
LIMIT 50;
```

**Query Explanation:**

- `eq.email_type = 'reminder'` → Only reminder emails (not confirmations)
- `eq.status = 'pending'` → Not yet sent or previously failed
- `eq.scheduled_at <= NOW()` → Scheduled time has passed (due now)
- `b.status = 'confirmed'` → Skip cancelled/rescheduled bookings
- `LIMIT 50` → Batch processing to prevent timeout

### Cron Job Algorithm

```
1. Connect to database
2. Query: Find all pending reminders WHERE scheduled_at <= NOW()
3. For each reminder in batch:
   a. Build email data array from joined booking/customer data
   b. Call $emailService->sendReminderEmail($emailData)
   c. If SUCCESS:
      - UPDATE email_queue SET status='sent', sent_at=NOW()
   d. If FAILED:
      - UPDATE email_queue SET status='failed', retry_count++, error_message=?
   e. Sleep 500ms (rate limiting protection)
4. Log summary (sent count, failed count)
5. Exit
```

### Example: 09:00 Daily Cron Scenario

If cron runs at **09:00:00** every morning:

| Booking Date/Time | scheduled_at (booking - 24h) | Will Send?                      |
| ----------------- | ---------------------------- | ------------------------------- |
| Dec 14, 10:00     | Dec 13, 10:00                | ✅ Yes (10:00 < 09:00 next day) |
| Dec 14, 14:00     | Dec 13, 14:00                | ❌ No (wait until Dec 14 09:00) |
| Dec 14, 08:00     | Dec 13, 08:00                | ✅ Yes (08:00 < 09:00)          |

**Note:** With hourly cron, reminders are sent closer to exactly 24h before.

---

## Recommended Database Index

Add to `admin/includes/database_indexes.sql`:

```sql
-- Indexes for email_queue table (cron job optimization)
CREATE INDEX IF NOT EXISTS idx_email_queue_scheduled_status
    ON email_queue(scheduled_at, status);
CREATE INDEX IF NOT EXISTS idx_email_queue_type_status
    ON email_queue(email_type, status);
```

---

## Configuration Constants

### File: `config/email_config.php`

```php
// SMTP Settings (Gmail)
define('SMTP_HOST', 'smtp.gmail.com');
define('SMTP_PORT', 587);
define('SMTP_USERNAME', 'lumierebeautysalon2022@gmail.com');
define('SMTP_PASSWORD', 'xxxx xxxx xxxx xxxx'); // App Password
define('SMTP_FROM_EMAIL', 'noreply@lumiere-salon.com');
define('SMTP_FROM_NAME', 'Lumière Beauty Salon');

// Salon Details (used in templates)
define('SALON_NAME', 'Lumière Beauty Salon');
define('SALON_LOCATION', 'Hilltop, Kota Kinabalu, Sabah');
define('SALON_PHONE', '+60 12 345 6789');
define('SALON_ADDRESS', 'Hilltop, Kota Kinabalu, 88300, Sabah');
```

---

## Error Handling & Logging

| Error Type             | Handling                                                            |
| ---------------------- | ------------------------------------------------------------------- |
| SMTP Connection Failed | Log to error_log, return `['success' => false, 'error' => message]` |
| Invalid Email Address  | PHPMailer validates, exception caught and logged                    |
| Booking Not Found      | Query returns empty, skip and log warning                           |
| Rate Limit Hit         | 500ms delay between sends, batch limit of 50                        |

---

## Testing Checklist

- [ ] Create a test booking and verify instant confirmation email received
- [ ] Check `email_queue` table for scheduled reminder entry
- [ ] Manually run `php cron/send_reminder_emails.php` to test reminder delivery
- [ ] Verify emails render correctly in Gmail, Outlook, Apple Mail
- [ ] Test plain text fallback by viewing email source
- [ ] Confirm cancelled bookings don't receive reminders

---

## Summary

| Component       | File                            | Function                                             |
| --------------- | ------------------------------- | ---------------------------------------------------- |
| Email Templates | `includes/EmailService.php`     | `getConfirmationTemplate()`, `getReminderTemplate()` |
| Instant Trigger | `api/create_booking.php`        | Line 55-75, called after booking INSERT              |
| Reminder Query  | `cron/send_reminder_emails.php` | `WHERE scheduled_at <= NOW() AND status='pending'`   |
| Queue Table     | `email_queue`                   | Stores scheduled reminders with status tracking      |

The system is already fully implemented and operational. This plan documents the technical approach for reference and future maintenance.
