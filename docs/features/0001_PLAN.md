# Staff Management CRUD - Technical Plan

## Context

Implement complete CRUD (Create, Read, Update, Delete) operations for staff management in the admin module. The system must allow admins to manage staff members with their profiles, images, roles, and status. This follows the design layout shown in the UI mockup with larger elements for better usability.

## Database Schema

- **Table:** `staff`
- **Key Fields:** `staff_email` (PK), `phone`, `password`, `first_name`, `last_name`, `bio`, `role` (enum: 'staff', 'admin'), `staff_image` (varchar path), `is_active` (tinyint), `created_at`
- **Relationships:** Foreign keys in `staff_schedule` and `staff_service` tables

## Files to Create/Modify

### New Files:

1. `config/db_connect.php` - Centralized database connection using MySQLi
2. `admin/staff/list.php` - Main staff listing page (READ operation with server-side rendering)
3. `admin/staff/list.js` - Client-side filtering and form handling
4. `api/admin/staff/create.php` - CREATE operation endpoint
5. `api/admin/staff/update.php` - UPDATE operation endpoint
6. `api/admin/staff/delete.php` - DELETE operation endpoint
7. `api/admin/staff/toggle_status.php` - Toggle active/inactive status

### Modified Files:

- None (starting fresh implementation)

## Implementation Details

### Phase 1: Database Connection & READ Operation

**1.1 Database Connection (`config/db_connect.php`)**

- Create MySQLi connection using constants from `config/config.php`
- Use `getDBConnection()` function pattern
- Handle connection errors gracefully

**1.2 Staff List Page (`admin/staff/list.php`)**

- Include authentication check
- Fetch all staff records using prepared statement
- Display in table format matching design mockup
- Include search and role filter UI (client-side filtering)
- Show: avatar (initials or image), name, bio, contact info, role badge, status badge, joined date, action buttons
- Make elements larger: avatars 64px, padding 1.5rem, font sizes increased

**1.3 Client-Side JavaScript (`admin/staff/list.js`)**

- Load staff data on page load
- Implement search filter (name, email, phone)
- Implement role filter dropdown
- Display staff in table with proper formatting
- Handle empty states and loading states

### Phase 2: CREATE Operation

**2.1 Create API (`api/admin/staff/create.php`)**

- Validate all required fields (email, phone, first_name, last_name, password, role)
- Check email uniqueness
- Check phone uniqueness
- Hash password using `password_hash()` with PASSWORD_DEFAULT
- Handle image upload (store file path, not BLOB)
- Use prepared statements for INSERT
- Return JSON response

**2.2 Form Modal**

- Add "Add Staff" button that opens modal
- Form fields: email, phone, first_name, last_name, password, role, bio, image upload
- Client-side validation
- Submit via AJAX to create API

### Phase 3: UPDATE Operation

**3.1 Update API (`api/admin/staff/update.php`)**

- Validate email exists
- Update only provided fields
- If password provided, hash and update; otherwise keep existing
- Handle image update if new image uploaded
- Use prepared statements for UPDATE
- Return JSON response

**3.2 Edit Modal**

- Pre-populate form with existing staff data
- Make email read-only (primary key)
- Password optional (only update if provided)
- Submit via AJAX to update API

### Phase 4: DELETE Operation

**4.1 Delete API (`api/admin/staff/delete.php`)**

- Check for foreign key constraints (bookings, schedules)
- Soft delete option: set `is_active = 0` instead of hard delete (safer)
- OR hard delete if no dependencies
- Use prepared statements
- Return JSON response

**4.2 Delete Confirmation**

- Show confirmation modal before delete
- Display staff name in confirmation
- Call delete API on confirm

### Phase 5: Toggle Status

**5.1 Toggle Status API (`api/admin/staff/toggle_status.php`)**

- Toggle `is_active` field (0 â†” 1)
- Use prepared statements
- Return updated status in response

## Security Requirements

- All database queries MUST use prepared statements (MySQLi)
- Password hashing: `password_hash($password, PASSWORD_DEFAULT)`
- Input validation: server-side validation for all fields
- CSRF protection: Include CSRF token in forms
- Authentication: Require admin authentication for all operations
- XSS prevention: Escape all output using `htmlspecialchars()`

## UI/UX Requirements

- Follow design mockup layout
- Larger elements: avatars 64px (vs 48px), increased padding, larger fonts
- Color scheme: Brown/Earthy tones (#c29076 primary)
- Responsive design for mobile
- Loading states during API calls
- Success/error notifications using SweetAlert2
- Empty state when no staff found

## Algorithm: Staff List Query

1. Start with base SELECT query: `SELECT * FROM staff WHERE 1=1`
2. If role filter provided: `AND role = ?`
3. If search term provided: `AND (first_name LIKE ? OR last_name LIKE ? OR staff_email LIKE ?)`
4. If active_only filter: `AND is_active = 1`
5. Order by: `ORDER BY first_name, last_name`
6. Prepare statement
7. Bind parameters dynamically based on filters
8. Execute and fetch results
9. Return array of staff records

