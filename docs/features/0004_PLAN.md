# Master Calendar - Technical Plan

## Context

Build a comprehensive **Master Calendar** interface for the admin module that displays all salon bookings across all staff members with multiple view modes (Day/Week/Month), filtering capabilities, and interactive booking details. This centralizes booking oversight and enables administrators to monitor booking activity, identify scheduling conflicts, and access detailed customer and service information.

**Design Aesthetic**: LumiÃ¨re minimal/classy style with brown/earthy tones (`#c29076`, `#968073`), generous whitespace, color-coded status indicators, and card-based layouts.

**Recent Updates**:
- Day view time slots: 10:00 AM - 10:00 PM (operating hours)
- Real-time timeline indicator: Brown line with dot showing current time (today only)
- Booking card redesign: Icon at bottom right corner indicating click-to-view
- Color coding: Red for cancelled, Grey for no-show (separated)
- Staff schedules: Clean, minimal card-based design

---

## Requirements Reference

From [requirements.md](../.kiro/specs/admin-module/requirements.md):

**Requirement 8**: Master Calendar View

- Display all bookings across all staff and time slots
- Filter by date range, staff, service type, and status
- Color-coded statuses: Green (confirmed), Blue (completed), Red (cancelled/no-show), Grey (available)
- Load within 3 seconds

**Requirement 12**: Booking Details from Calendar

- Click booking to view customer details, services, staff, pricing, booking history
- Display special requests/remarks, promo codes, discounts
- Show service sequence for multi-service bookings

---

## Files to Create/Modify

| File                             | Purpose                             | Status                 |
| -------------------------------- | ----------------------------------- | ---------------------- |
| `admin/calendar/master.php`      | Main calendar UI page               | âœ… Exists              |
| `admin/calendar/master.js`       | Calendar logic and interactions     | âœ… Exists              |
| `api/admin/bookings/list.php`    | API to fetch bookings with filters  | âœ… Exists              |
| `api/admin/bookings/details.php` | API to fetch single booking details | ğŸ”¨ Create              |
| `admin/css/admin-style.css`      | Calendar-specific styles            | ğŸ”¨ Add calendar styles |

---

## API Endpoints

### 1. GET `/api/admin/bookings/list.php`

**Purpose**: Fetch bookings based on view (day/week/month) and filters

**Query Parameters**:

```
?date=2025-12-14                          // For day view
?start_date=2025-12-08&end_date=2025-12-14  // For week/month view
&staff_email=stylist@lumiere.com           // Optional filter
&status=confirmed                          // Optional filter
```

**Response Format**:

```json
{
  "success": true,
  "bookings": [
    {
      "booking_id": "B0001234",
      "customer_name": "John Doe",
      "customer_email": "john@example.com",
      "customer_phone": "60123456789",
      "booking_date": "2025-12-14",
      "start_time": "10:00:00",
      "expected_finish_time": "11:30:00",
      "status": "confirmed",
      "total_price": 120.0,
      "services": [
        {
          "service_id": 1,
          "service_name": "Haircut & Blow Dry",
          "service_category": "Hair",
          "staff_name": "Jane Smith",
          "staff_email": "jane@lumiere.com",
          "quoted_duration_minutes": 60,
          "quoted_cleanup_minutes": 15,
          "quoted_price": 80.0
        }
      ]
    }
  ],
  "staff_schedules": [
    {
      "staff_email": "jane@lumiere.com",
      "staff_name": "Jane Smith",
      "work_date": "2025-12-14",
      "start_time": "10:00:00",
      "end_time": "18:00:00",
      "status": "working"
    }
  ]
}
```

**Implementation Notes**:

- Join `Booking` + `Customer` + `Booking_Service` + `Service` + `Staff` tables
- Group services by `booking_id` using JSON aggregation or multiple queries
- Include `Staff_Schedule` data for the requested date range
- Time range: 10:00 AM - 10:00 PM (operating hours)
- âœ… **File already exists** - needs authentication fix (see investigation below)

---

### 2. GET `/api/admin/bookings/details.php`

**Purpose**: Fetch detailed booking information for modal display

**Query Parameters**:

```
?booking_id=B0001234
```

**Response Format**:

```json
{
  "success": true,
  "booking": {
    "booking_id": "B0001234",
    "customer_name": "John Doe",
    "customer_email": "john@example.com",
    "customer_phone": "60123456789",
    "booking_date": "2025-12-14",
    "start_time": "10:00:00",
    "expected_finish_time": "11:30:00",
    "total_duration_minutes": 90,
    "status": "confirmed",
    "total_price": 120.0,
    "discount_amount": 0.0,
    "promo_code": null,
    "remarks": "Please use organic products",
    "services": [
      {
        "service_name": "Haircut & Blow Dry",
        "service_category": "Hair",
        "staff_name": "Jane Smith",
        "quoted_duration_minutes": 60,
        "quoted_cleanup_minutes": 15,
        "quoted_price": 80.0,
        "special_request": "Short layers please"
      }
    ],
    "booking_history": [
      {
        "booking_date": "2025-11-10",
        "start_time": "14:00:00",
        "service_count": 2,
        "total_price": 150.0,
        "status": "completed"
      }
    ]
  }
}
```

**SQL Queries**:

1. **Main Booking Data**:

```sql
SELECT b.*,
       CONCAT(c.first_name, ' ', c.last_name) as customer_name,
       c.customer_email, c.phone as customer_phone
FROM Booking b
INNER JOIN Customer c ON b.customer_email = c.customer_email
WHERE b.booking_id = ?
```

2. **Services in Booking**:

```sql
SELECT bs.*, s.service_name, s.service_category,
       CONCAT(st.first_name, ' ', st.last_name) as staff_name
FROM Booking_Service bs
INNER JOIN Service s ON bs.service_id = s.service_id
INNER JOIN Staff st ON bs.staff_email = st.staff_email
WHERE bs.booking_id = ?
ORDER BY bs.start_time
```

3. **Customer Booking History** (last 10 bookings):

```sql
SELECT b.booking_date, b.start_time, b.total_price, b.status,
       COUNT(bs.service_id) as service_count
FROM Booking b
LEFT JOIN Booking_Service bs ON b.booking_id = bs.booking_id
WHERE b.customer_email = ? AND b.booking_id != ?
GROUP BY b.booking_id
ORDER BY b.booking_date DESC, b.start_time DESC
LIMIT 10
```

---

## UI Components

### Master Calendar Page (`admin/calendar/master.php`)

**Layout Structure**:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  [Day|Week|Month]  â—€ Dec 14, 2025 â–¶  [Today]   â”‚
â”‚  [Staff â–¼]  [Status â–¼]                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â— Confirmed  â— Completed  â— Cancelled  â— Availâ”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                 â”‚
â”‚  [Calendar Content Area - View Dependent]       â”‚
â”‚                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**View Modes**:

1. **Day View**: Time-slotted vertical timeline (10 AM - 10 PM hourly slots)

   - Each hour shows all bookings starting at that time
   - Bookings displayed as color-coded cards with click-to-view icon at bottom right
   - Real-time timeline indicator (brown line with dot) shows current time when viewing today
   - Empty slots show "No bookings"

2. **Week View**: Grid of 7 days with booking cards stacked per day

   - Each day card shows date + all bookings
   - Scroll through bookings within each day
   - Time slots from 10 AM - 10 PM

3. **Month View**: Grid of date cards showing booking counts
   - Each date shows total count and breakdown by status
   - Click date to switch to day view for that date

**Color Coding** (per requirements):

- Green `#69B578`: Confirmed
- Blue `#4A90E2`: Completed
- Red `#D0021B`: Cancelled
- Grey `#9E9E9E`: No-show
- Grey `#A0A0A0`: Available slots

---

### Booking Card Component (Day View)

**HTML Structure**:

```html
<div
  class="admin-calendar-event status-confirmed"
  onclick="viewBookingDetails('B0001234')"
>
  <div class="event-main">
    <div class="event-header">
      <div class="event-datetime">10:00 AM - Dec 14, 2025</div>
      <span class="status-pill status-confirmed">CONFIRMED</span>
    </div>
    <div class="event-fields">
      <div class="event-field">
        <span class="event-label">Customer</span>
        <span class="event-value">John Doe</span>
      </div>
      <div class="event-field">
        <span class="event-label">Service</span>
        <span class="event-value">Haircut & Blow Dry</span>
      </div>
      <div class="event-field">
        <span class="event-label">Duration</span>
        <span class="event-value">90 min</span>
      </div>
    </div>
  </div>
  <div class="event-action-cue" title="Click to view details">
    <svg><!-- Clock icon --></svg>
  </div>
</div>
```

**Features**:
- Card-based design with hover effects
- Status pill with color-coded background
- Click-to-view icon at bottom right corner (brown/earth tone on hover)
- Real-time timeline indicator (brown line with dot) when viewing today's date

**CSS Styles** (in `admin/css/admin-style.css`):

```css
.admin-calendar-event {
  background: white;
  border: 1px solid var(--border-color);
  border-radius: 8px;
  padding: 12px;
  margin-bottom: 8px;
  cursor: pointer;
  position: relative;
  display: flex;
  justify-content: space-between;
  align-items: flex-start;
}

.admin-calendar-event:hover {
  box-shadow: 0 3px 8px rgba(0, 0, 0, 0.12);
  transform: translateY(-1px);
}

.event-action-cue {
  position: absolute;
  bottom: 8px;
  right: 8px;
  width: 32px;
  height: 32px;
  background: #f8f9fa;
  border-radius: 50%;
  color: #c29076;
  transition: all 0.2s ease;
}

.admin-calendar-event:hover .event-action-cue {
  background: #c29076;
  color: white;
  transform: scale(1.1);
}

/* Real-time Timeline Indicator */
.real-time-indicator {
  position: absolute;
  left: 0;
  right: 0;
  height: 2px;
  background: #c29076;
  z-index: 100;
}
```

**Color Coding**:
- Confirmed: Green background `#e8f5e9`, text `#2e7d32`
- Completed: Blue background `#e3f2fd`, text `#1565c0`
- Cancelled: Red background `#ffebee`, text `#c62828`
- No-show: Grey background `#f5f5f5`, text `#616161`

---

### Booking Details Modal

**Triggered By**: Clicking any booking card

**Modal Content Sections**:

1. Customer Information (name, email, phone)
2. Booking Information (ID, date, time, status, duration, remarks)
3. Services List (each service with staff, duration, price, special requests)
4. Pricing (promo code, discount, total)
5. Customer Booking History (past 10 bookings with dates, service count, total, status)

**Modal Styling**:

- Max width 700px
- White background, rounded corners
- Sections separated with subtle dividers
- Scroll for long content (max-height for history section)

---

## JavaScript Functions

### Core Calendar Functions

| Function                        | Purpose                                                               | Parameters         |
| ------------------------------- | --------------------------------------------------------------------- | ------------------ | ------ | -------- |
| `initializeCalendar()`          | Initialize on page load, set current date, load staff list, load data | None               |
| `loadCalendarData()`            | Fetch bookings via API based on current view + filters                | None               |
| `renderCalendar()`              | Route to appropriate view renderer                                    | None               |
| `renderDayView()`               | Generate HTML for day view (hourly slots 10 AM - 10 PM)              | None               |
| `addRealTimeIndicator()`        | Add brown timeline indicator with dot for current time (today only)  | None               |
| `renderWeekView()`              | Generate HTML for week view (7 day cards)                             | None               |
| `renderMonthView()`             | Generate HTML for month view (date cards with counts)                 | None               |
| `renderBookingCard(booking)`    | Generate booking card HTML                                            | `booking` object   |
| `viewBookingDetails(bookingId)` | Fetch and display booking in modal                                    | `bookingId` string |
| `renderBookingDetails(booking)` | Populate modal with booking data                                      | `booking` object   |
| `switchView(view)`              | Change view mode, update UI, reload data                              | `'day'             | 'week' | 'month'` |
| `changeDate(direction)`         | Navigate forward/back by 1 day/week/month                             | `1` or `-1`        |
| `goToToday()`                   | Reset to current date                                                 | None               |
| `applyFilters()`                | Reload data when filters change                                       | None               |
| `updateDateDisplay()`           | Update date header text                                               | None               |

### View Navigation Logic

**Day View**:

- `changeDate(1)`: Add 1 day to `currentDate`
- `changeDate(-1)`: Subtract 1 day
- Display: "December 14, 2025"
- Time slots: 10:00 AM - 10:00 PM (hourly)
- Real-time indicator: Brown line with dot showing current time (only on today's date)

**Week View**:

- `changeDate(1)`: Add 7 days
- `changeDate(-1)`: Subtract 7 days
- Display: "Dec 8 - Dec 14, 2025"
- API params: `start_date` = start of week (Sunday), `end_date` = end of week (Saturday)

**Month View**:

- `changeDate(1)`: Add 1 month
- `changeDate(-1)`: Subtract 1 month
- Display: "December 2025"
- API params: `start_date` = first day of month, `end_date` = last day of month

---

## Implementation Algorithm

### Page Load Flow

```
1. DOM Ready
   â”œâ”€ Initialize currentDate = new Date()
   â”œâ”€ Load staff list for filter dropdown
   â”‚  â””â”€ Fetch from /api/admin/staff/list.php
   â”œâ”€ Add event listeners to filter dropdowns
   â””â”€ Call loadCalendarData()

2. loadCalendarData()
   â”œâ”€ Show loading state
   â”œâ”€ Build query params based on currentView
   â”‚  â”œâ”€ Day: ?date=YYYY-MM-DD
   â”‚  â”œâ”€ Week: ?start_date=...&end_date=...
   â”‚  â””â”€ Month: ?start_date=...&end_date=...
   â”œâ”€ Add staff/status filters if selected
   â”œâ”€ Fetch from /api/admin/bookings/list.php
   â”œâ”€ Store response in bookingsData & staffSchedulesData
   â”œâ”€ Hide loading state
   â””â”€ Call renderCalendar()

3. renderCalendar()
   â”œâ”€ Route to renderDayView() / renderWeekView() / renderMonthView()
   â””â”€ Render staff schedules section

4. User Interactions
   â”œâ”€ Click view button â†’ switchView()
   â”œâ”€ Click arrow â†’ changeDate()
   â”œâ”€ Click Today â†’ goToToday()
   â”œâ”€ Change filter â†’ applyFilters()
   â””â”€ Click booking card â†’ viewBookingDetails()
```

### Booking Details Modal Flow

```
1. viewBookingDetails(bookingId)
   â”œâ”€ Open modal, show "Loading..."
   â”œâ”€ Fetch from /api/admin/bookings/details.php?booking_id=...
   â”œâ”€ Parse response
   â””â”€ Call renderBookingDetails(booking)

2. renderBookingDetails(booking)
   â”œâ”€ Build HTML for customer info section
   â”œâ”€ Build HTML for booking info section
   â”œâ”€ Loop through services, build service cards
   â”œâ”€ Build HTML for pricing section
   â”œâ”€ IF booking_history exists
   â”‚  â””â”€ Build HTML for history section
   â””â”€ Set modal content innerHTML
```

---

## Authentication & Error Handling

### Current Issue (from screenshot)

**Error**: `401 Unauthorized` when calling `/api/admin/bookings/list.php`

**Root Cause**: Admin authentication check failing in API endpoint

**Files to Investigate**:

1. `admin/includes/auth_check.php` - Admin auth functions
2. `api/admin/bookings/list.php` - Authentication check at line 16
3. Session handling - Verify `$_SESSION['admin']` is set

**Expected Flow**:

```php
// admin/includes/auth_check.php
function isAdminAuthenticated() {
    return isset($_SESSION['admin']) && isset($_SESSION['admin']['email']);
}

function requireAdminAuth() {
    if (!isAdminAuthenticated()) {
        header('Location: /admin/login.html');
        exit;
    }
}

// api/admin/bookings/list.php
require_once '../../../admin/includes/auth_check.php';

if (!isAdminAuthenticated()) {
    http_response_code(401);
    echo json_encode(['success' => false, 'error' => 'Unauthorized']);
    exit;
}
```

**Fix Required**: Ensure admin login sets proper session variables and API checks session correctly

---

## Testing Checklist

### Functional Tests

- [ ] Day view displays bookings in hourly slots (10 AM - 10 PM)
- [ ] Real-time timeline indicator shows current time (brown line with dot) on today's date
- [ ] Real-time indicator only appears when viewing today's date
- [ ] Booking cards display click-to-view icon at bottom right corner
- [ ] Week view displays 7 day cards with bookings (10 AM - 10 PM slots)
- [ ] Month view displays date cards with booking counts
- [ ] View switcher buttons work correctly
- [ ] Date navigation arrows work for day/week/month
- [ ] "Today" button resets to current date
- [ ] Staff filter dropdown filters bookings
- [ ] Status filter dropdown filters bookings
- [ ] Color coding: Red for cancelled, Grey for no-show
- [ ] Clicking booking card opens details modal
- [ ] Staff schedules section displays cleanly with improved design
- [ ] Modal displays all booking information correctly
- [ ] Modal displays customer booking history
- [ ] Modal close button works
- [ ] Empty state shows when no bookings exist

### API Tests

- [ ] `/api/admin/bookings/list.php?date=2025-12-14` returns day bookings
- [ ] `/api/admin/bookings/list.php?start_date=...&end_date=...` returns range
- [ ] `/api/admin/bookings/details.php?booking_id=...` returns full details
- [ ] API returns 401 when not authenticated
- [ ] API validates date format parameters

### UI/UX Tests

- [ ] Color coding matches requirements (green/blue/red for cancelled/grey for no-show)
- [ ] Real-time indicator uses brown/earth tone (#c29076) matching LumiÃ¨re brand
- [ ] Booking card hover effects work smoothly
- [ ] Click-to-view icon animates on hover (brown background)
- [ ] Staff schedules section has clean, minimal design
- [ ] Page loads within 3 seconds
- [ ] Responsive on desktop, tablet, mobile
- [ ] LumiÃ¨re aesthetic maintained (brown tones, minimal design)
- [ ] No console errors
- [ ] Loading states display during API calls

---

## Future Enhancements (Out of Scope)

- Drag-and-drop rescheduling (partial code exists in `master.js`)
- Inline status updates from calendar
- Bulk operations (multi-select bookings)
- Export calendar to PDF/iCal
- Real-time updates via WebSocket
