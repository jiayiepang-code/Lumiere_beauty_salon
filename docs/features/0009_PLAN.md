# Admin Dashboard Overview Database Integration - Technical Plan

## Context

Connect the admin dashboard overview (`admin/index.php`) hardcoded sections to the database. The dashboard already has KPI statistics cards (Total Bookings, Active Staff, Today's Income, Pending Requests) linked to the database, but three sections remain hardcoded: "Today's Appointments", "Recent Activity", and "Top Services Today". This plan implements database queries to replace the hardcoded data with real-time information from the `Booking`, `Booking_Service`, `Service`, `Customer`, and `Staff` tables.

**Current State:**

- `admin/index.php` - KPI cards are database-linked (lines 24-78)
- "Today's Appointments" section (lines 152-195) - Hardcoded appointment items (Amanda Wong, Lisa Tan, Rachel Lim)
- "Recent Activity" section (lines 200-229) - Hardcoded activity items with mock timestamps
- "Top Services Today" section (lines 232-260) - Hardcoded service names and counts with fake percentages

**Target State:**

- All dashboard sections display real data from database
- Today's Appointments shows actual bookings for current date
- Recent Activity shows real booking status changes and new bookings
- Top Services Today shows actual service booking counts for today with accurate percentages

---

## Database Schema

**Primary Tables:**

- `Booking` - Contains bookings with `booking_id`, `customer_email`, `booking_date`, `start_time`, `expected_finish_time`, `status`, `total_price`, `created_at`, `updated_at`
- `Booking_Service` - Links bookings to services with `booking_id`, `service_id`, `staff_email`, `service_status`, `sequence_order`
- `Service` - Service details with `service_id`, `service_name`, `service_category`
- `Customer` - Customer info with `customer_email`, `first_name`, `last_name`
- `Staff` - Staff info with `staff_email`, `first_name`, `last_name`

**Key Relationships:**

- `Booking.customer_email` ‚Üí `Customer.customer_email`
- `Booking_Service.booking_id` ‚Üí `Booking.booking_id`
- `Booking_Service.service_id` ‚Üí `Service.service_id`
- `Booking_Service.staff_email` ‚Üí `Staff.staff_email`

---

## Files to Create or Modify

### Files to Create:

1. **`admin/js/dashboard.js`** - Client-side JavaScript for dashboard dynamic content
   - Load today's appointments from API on page load
   - Load recent activity from API on page load
   - Load top services from API on page load
   - Render appointment items dynamically
   - Render activity items dynamically
   - Render service items with calculated percentages
   - Handle empty states (no appointments/activities/services)
   - Handle loading states
   - Handle API errors gracefully

### Files to Modify:

1. **`admin/index.php`** - Main dashboard page

   - Remove hardcoded appointment items (lines 156-193)
   - Remove hardcoded activity items (lines 203-228)
   - Remove hardcoded service items (lines 236-258)
   - Add empty container divs with IDs for JavaScript to populate:
     - `<div id="appointments-list-container" class="appointments-list"></div>`
     - `<div id="activity-list-container" class="activity-list"></div>`
     - `<div id="services-list-container" class="services-list"></div>`
   - Add loading indicators/spinners for each section
   - Add script tag to include `admin/js/dashboard.js` before closing `</body>`
   - Optionally: Add server-side queries to fetch this data (alternative to API approach)

2. **`api/admin/bookings/list.php`** (Already exists - may need minor enhancement)
   - Already supports filtering by date via `date` parameter
   - Already returns booking data with customer names and services
   - Can be used to fetch today's appointments by passing `date` parameter
   - May need to add ordering by `start_time` for appointments display
   - Consider adding limit parameter for recent activity (e.g., last 10 activities)

### Alternative: Server-Side Approach

If preferred, data can be fetched server-side in `admin/index.php` instead of using JavaScript:

- Add queries in PHP section (around lines 32-78) to fetch:
  - Today's appointments
  - Recent activity (last N bookings with status changes)
  - Top services today
- Loop through results to render HTML in PHP
- No JavaScript needed for initial load (but may be useful for refresh/reload)

---

## Implementation Details

### Data Fetching Approaches

**Approach A: Client-Side (JavaScript + API)** - Recommended for consistency with other admin pages

- Use existing `api/admin/bookings/list.php` endpoint
- JavaScript fetches data on page load
- Renders HTML dynamically
- Allows easy refresh/reload without page reload
- Follows pattern used in `admin/calendar/master.js` and other admin pages

**Approach B: Server-Side (PHP)** - Simpler, no JavaScript needed

- Fetch data in `admin/index.php` PHP section
- Render HTML directly in PHP loops
- Faster initial load (no extra API call)
- Requires page refresh to update data

**Recommendation:** Use Approach A (client-side) for consistency with existing admin pages that use JavaScript for dynamic content.

### Data Requirements

1. **Today's Appointments:**

   - Query bookings for `booking_date = CURRENT_DATE()`
   - Include customer name (first_name + last_name)
   - Include service names (from Booking_Service join)
   - Include start_time and expected_finish_time
   - Include staff name for each service
   - Include booking status
   - Order by start_time ASC
   - Limit to reasonable number (e.g., 20) or show all
   - Generate customer initials for avatar (e.g., "AW" for Amanda Wong)

2. **Recent Activity:**

   - Query recent bookings ordered by `created_at` or `updated_at` DESC
   - Include activity type: "New booking", "Completed", "Cancellation", "Status changed"
   - Determine activity type from booking status and timestamps
   - Include customer name and service name
   - Calculate relative time (e.g., "10 mins ago", "2 hours ago")
   - Limit to last 10-15 activities
   - Consider: Track actual status changes in `updated_at` vs new bookings in `created_at`

3. **Top Services Today:**
   - Count services booked today from `Booking_Service` table
   - Join with `Service` to get service names
   - Filter by bookings with `booking_date = CURRENT_DATE()`
   - Group by service_id/service_name
   - Count occurrences
   - Calculate percentage: (service_count / total_services_today) \* 100
   - Order by count DESC
   - Limit to top 5-10 services
   - Calculate bar width percentage for visual representation

### Database Queries

**Today's Appointments Query:**

```sql
SELECT
    b.booking_id,
    b.start_time,
    b.expected_finish_time,
    b.status,
    c.first_name AS customer_first_name,
    c.last_name AS customer_last_name,
    GROUP_CONCAT(DISTINCT s.service_name SEPARATOR ', ') AS services,
    GROUP_CONCAT(DISTINCT CONCAT(st.first_name, ' ', st.last_name) SEPARATOR ', ') AS staff_names
FROM Booking b
INNER JOIN Customer c ON b.customer_email = c.customer_email
INNER JOIN Booking_Service bs ON b.booking_id = bs.booking_id
INNER JOIN Service s ON bs.service_id = s.service_id
INNER JOIN Staff st ON bs.staff_email = st.staff_email
WHERE b.booking_date = CURDATE()
GROUP BY b.booking_id, b.start_time, b.expected_finish_time, b.status, c.first_name, c.last_name
ORDER BY b.start_time ASC
LIMIT 20
```

**Recent Activity Query:**

```sql
SELECT
    b.booking_id,
    b.status,
    b.created_at,
    b.updated_at,
    c.first_name AS customer_first_name,
    c.last_name AS customer_last_name,
    (SELECT GROUP_CONCAT(s.service_name SEPARATOR ', ')
     FROM Booking_Service bs
     INNER JOIN Service s ON bs.service_id = s.service_id
     WHERE bs.booking_id = b.booking_id
     LIMIT 1) AS first_service_name
FROM Booking b
INNER JOIN Customer c ON b.customer_email = c.customer_email
WHERE b.created_at >= DATE_SUB(NOW(), INTERVAL 7 DAY)
ORDER BY
    CASE
        WHEN b.created_at = b.updated_at THEN b.created_at
        ELSE b.updated_at
    END DESC
LIMIT 15
```

Note: Activity type can be determined by comparing `created_at` vs `updated_at` and checking `status` field.

**Top Services Today Query:**

```sql
SELECT
    s.service_id,
    s.service_name,
    COUNT(*) AS booking_count,
    (COUNT(*) * 100.0 / (SELECT COUNT(*) FROM Booking_Service bs2
                         INNER JOIN Booking b2 ON bs2.booking_id = b2.booking_id
                         WHERE b2.booking_date = CURDATE())) AS percentage
FROM Booking_Service bs
INNER JOIN Booking b ON bs.booking_id = b.booking_id
INNER JOIN Service s ON bs.service_id = s.service_id
WHERE b.booking_date = CURDATE()
GROUP BY s.service_id, s.service_name
ORDER BY booking_count DESC
LIMIT 10
```

---

## Security Considerations

1. **Prepared Statements:** All database queries must use prepared statements (already enforced in existing code)
2. **Authentication:** Dashboard already protected by `requireAdminAuth()` - no additional auth needed
3. **Date Handling:** Use `CURDATE()` or prepared date parameters to prevent SQL injection
4. **Input Sanitization:** No user input in dashboard overview queries (uses current date only)
5. **Error Handling:** Don't expose database errors to frontend - log errors, show user-friendly messages
6. **Data Limits:** Use LIMIT clauses to prevent excessive data loading

---

## Error Handling

1. **API Errors:**

   - Network failures ‚Üí Show "Unable to load data" message in section
   - 401 responses ‚Üí Dashboard already protected, but if API fails, show error message
   - 500 responses ‚Üí Log error server-side, show "Data temporarily unavailable" message
   - Empty results ‚Üí Show appropriate empty state (e.g., "No appointments today")

2. **Database Query Errors:**

   - Log all errors using `error_log()`
   - Catch exceptions in try-catch blocks
   - Default to empty arrays if queries fail
   - Don't break entire page if one section fails

3. **Frontend Error Handling:**
   - Use try-catch in JavaScript fetch calls
   - Show loading spinners during data fetch
   - Replace loading spinner with error message or empty state on failure
   - Ensure page is still usable if dashboard sections fail to load

---

## Files Reference Table

| File                            | Type | Action       | Purpose                                                                |
| ------------------------------- | ---- | ------------ | ---------------------------------------------------------------------- |
| `admin/js/dashboard.js`         | JS   | üî® Create    | Load and render dashboard dynamic sections                             |
| `admin/index.php`               | PHP  | ‚úèÔ∏è Modify    | Replace hardcoded HTML with dynamic containers                         |
| `api/admin/bookings/list.php`   | PHP  | ‚úÖ Exists    | Use existing endpoint for bookings data (may need minor enhancement)   |
| `admin/calendar/master.js`      | JS   | ‚úÖ Reference | Pattern for API calls and data rendering                               |
| `admin/includes/auth_check.php` | PHP  | ‚úÖ Exists    | Already protects dashboard                                             |
| `config/db_connect.php`         | PHP  | ‚úÖ Exists    | Database connection                                                    |
| `admin/css/admin-style.css`     | CSS  | ‚úÖ Exists    | Styling for dashboard sections (may need additions for loading states) |

---

## Implementation Phases

### Phase 1: Today's Appointments

1. Modify `admin/index.php` to replace hardcoded appointments with empty container div
2. Create `admin/js/dashboard.js` with function to fetch today's bookings
3. Use `api/admin/bookings/list.php?date=YYYY-MM-DD` to fetch today's data
4. Render appointment items with customer names, services, times, staff, status
5. Generate customer initials for avatars
6. Handle empty state (no appointments today)
7. Test with various booking scenarios

### Phase 2: Recent Activity

1. Modify `admin/index.php` to replace hardcoded activity items with empty container
2. Add function in `dashboard.js` to fetch recent bookings
3. Determine activity type (New booking, Completed, Cancellation) from status and timestamps
4. Calculate relative time (e.g., "10 mins ago")
5. Render activity items dynamically
6. Limit to last 10-15 activities
7. Test with various activity scenarios

### Phase 3: Top Services Today

1. Modify `admin/index.php` to replace hardcoded service items with empty container
2. Add function in `dashboard.js` to fetch and calculate top services
3. Query or calculate service counts for today
4. Calculate percentages for bar width
5. Render service items with names, bars, and counts
6. Order by count descending
7. Limit to top 5-10 services
8. Handle empty state (no services booked today)

### Phase 4: Polish and Error Handling

1. Add loading spinners for each section
2. Add error handling for API failures
3. Add empty state messages
4. Test edge cases (no data, API errors, network failures)
5. Ensure consistent styling with existing dashboard
6. Optimize queries if needed (add indexes, optimize joins)

---

## Notes

- Dashboard is already protected by admin authentication - no additional auth needed
- Use existing `api/admin/bookings/list.php` endpoint to maintain consistency
- Follow JavaScript patterns from `admin/calendar/master.js` for API calls and rendering
- All database queries must use prepared statements (already enforced in existing code)
- Use `CURDATE()` or `date('Y-m-d')` for current date in queries
- Consider timezone handling if server timezone differs from Malaysia timezone
- Maintain existing CSS classes and structure for consistent styling
- Performance: Consider caching or limiting data if queries become slow with large datasets
- Future enhancements: Add refresh button, real-time updates, filtering options, pagination for long lists
