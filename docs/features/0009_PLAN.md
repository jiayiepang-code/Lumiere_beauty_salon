# Dashboard Overview Database Integration - Technical Plan

## Context

Connect the user dashboard overview (`user/dashboard.html`) to the database to display real customer data instead of hardcoded mock data. The dashboard currently shows a profile page with customer information (name, phone, email) that is hardcoded in `user/dashboard.js`. This plan implements customer authentication, session management, and database integration to fetch and display real customer data from the `customer` table.

**Current State:**
- `user/dashboard.html` - Static HTML with profile display
- `user/dashboard.js` - Contains hardcoded user object with mock data
- `js/login.js` - Customer login function only redirects without authentication
- No customer session management exists
- No API endpoints for customer profile data

**Target State:**
- Customer authentication system similar to admin authentication
- Session-based customer login
- API endpoint to fetch current customer profile data
- Dashboard displays real data from database
- Profile information dynamically loaded from `customer` table

---

## Database Schema

**Table:** `customer`

- `customer_email` (VARCHAR(100), PRIMARY KEY)
- `phone` (VARCHAR(20))
- `password` (VARCHAR(255)) - hashed passwords
- `first_name` (VARCHAR(100))
- `last_name` (VARCHAR(100))
- `created_at` (TIMESTAMP)

**Related Tables:**
- `Booking` - Contains booking history linked via `customer_email`
- `Booking_Service` - Contains service details for bookings

---

## Files to Create or Modify

### Files to Create:

1. **`user/includes/auth_check.php`** - Customer authentication utilities
   - Similar structure to `admin/includes/auth_check.php`
   - Functions: `isCustomerLoggedIn()`, `requireCustomerAuth()`, `getCurrentCustomer()`
   - Session structure: `$_SESSION['customer']` with `email`, `phone`, `first_name`, `last_name`
   - Session timeout: 30 minutes (same as admin)
   - Redirect to login page if not authenticated

2. **`api/customer/auth/login.php`** - Customer login API endpoint
   - Accept POST requests with `phone` and `password`
   - Validate phone format using existing `sanitizePhone()` and `isValidMalaysianPhone()` from `config/utils.php`
   - Query `customer` table by phone number
   - Verify password using `password_verify()`
   - Set `$_SESSION['customer']` with customer data
   - Return JSON response with success/error status
   - Use prepared statements for SQL injection prevention
   - Follow same security patterns as `api/admin/auth/login.php`

3. **`api/customer/profile.php`** - Get current customer profile data
   - Requires customer authentication (check `$_SESSION['customer']`)
   - Query `customer` table for current logged-in customer
   - Optionally join with `Booking` table to get:
     - Total bookings count
     - Last visit date (MAX booking_date)
     - Total spent (SUM of completed/confirmed bookings)
   - Return JSON with customer profile data
   - Handle case where customer has no bookings (LEFT JOIN)

4. **`api/customer/auth/logout.php`** - Customer logout endpoint
   - Destroy customer session
   - Clear `$_SESSION['customer']`
   - Return JSON success response
   - Redirect to login page

### Files to Modify:

1. **`user/dashboard.html`** ‚Üí **`user/dashboard.php`**
   - Convert to PHP file to enable server-side session checks
   - Include `user/includes/auth_check.php` at the top
   - Call `requireCustomerAuth()` to ensure user is logged in
   - Optionally pre-fetch customer data server-side (or keep as HTML and fetch via API)
   - Update profile form inputs to have proper IDs matching `dashboard.js` expectations

2. **`user/dashboard.js`**
   - Remove hardcoded user object
   - Add `loadCustomerProfile()` function that:
     - Makes fetch request to `api/customer/profile.php`
     - Handles authentication errors (redirect to login if 401)
     - Parses JSON response and calls `initDashboard(user)` with real data
   - Update `initDashboard()` to handle missing fields gracefully
   - Add error handling for network failures
   - Show loading state while fetching data

3. **`js/login.js`** - Update `validateCustomerLogin()` function
   - Replace mock login with real API call
   - Make POST request to `api/customer/auth/login.php` with phone and password
   - Handle response:
     - On success: Store any returned data, redirect to `user/dashboard.php`
     - On error: Display error message to user (use existing alert or SweetAlert2)
   - Show loading state during login request
   - Validate inputs before sending request

4. **`user/dashboard.html`** (if keeping as HTML instead of converting to PHP)
   - Add script tag to load `dashboard.js` before closing body tag
   - Ensure all form input IDs match what `dashboard.js` expects:
     - `profileFirst` - First name input
     - `profileLast` - Last name input  
     - `profilePhone` - Phone input
     - `profileEmail` - Email input
   - Add loading indicator for initial data fetch

---

## Implementation Details

### Customer Authentication Flow

1. **Login Process:**
   - User enters phone and password on login page
   - `js/login.js` sends POST to `api/customer/auth/login.php`
   - API validates phone format, queries database, verifies password
   - On success: Sets `$_SESSION['customer']` with customer data
   - Returns JSON response, JavaScript redirects to dashboard

2. **Session Structure:**
   ```php
   $_SESSION['customer'] = [
       'email' => $customer_data['customer_email'],
       'phone' => $customer_data['phone'],
       'first_name' => $customer_data['first_name'],
       'last_name' => $customer_data['last_name'],
       'last_activity' => time()
   ];
   ```

3. **Dashboard Access:**
   - `user/dashboard.php` includes `user/includes/auth_check.php`
   - Calls `requireCustomerAuth()` which:
     - Checks if `$_SESSION['customer']` exists
     - Validates session timeout (30 minutes)
     - Redirects to login if not authenticated

4. **Profile Data Fetching:**
   - Option A (Server-side): Fetch customer data in `dashboard.php`, pass to JavaScript via inline script or data attributes
   - Option B (Client-side): `dashboard.js` makes API call to `api/customer/profile.php` on page load
   - Recommended: Option B for consistency with admin dashboard pattern

### API Endpoint Specifications

**`api/customer/auth/login.php`:**
- Method: POST
- Input: JSON `{ "phone": "...", "password": "..." }`
- Output: JSON `{ "success": true/false, "message": "...", "customer": {...} }`
- Errors: 400 (bad input), 401 (invalid credentials), 500 (server error)

**`api/customer/profile.php`:**
- Method: GET
- Authentication: Required (session-based)
- Output: JSON with customer profile:
  ```json
  {
    "success": true,
    "customer": {
      "email": "...",
      "first_name": "...",
      "last_name": "...",
      "phone": "...",
      "created_at": "...",
      "total_bookings": 0,
      "total_spent": 0.00,
      "last_visit": null
    }
  }
  ```
- Errors: 401 (not authenticated), 500 (server error)

### Database Queries

**Customer Login Query:**
```sql
SELECT customer_email, phone, password, first_name, last_name 
FROM customer 
WHERE phone = ?
```

**Customer Profile Query (with stats):**
```sql
SELECT 
    c.customer_email AS email,
    c.first_name,
    c.last_name,
    c.phone,
    c.created_at,
    COUNT(b.booking_id) AS total_bookings,
    COALESCE(SUM(CASE WHEN b.status IN ('completed', 'confirmed') THEN b.total_price ELSE 0 END), 0) AS total_spent,
    MAX(b.booking_date) AS last_visit
FROM customer c
LEFT JOIN booking b ON c.customer_email = b.customer_email
WHERE c.customer_email = ?
GROUP BY c.customer_email, c.first_name, c.last_name, c.phone, c.created_at
```

---

## Security Considerations

1. **Password Hashing:** Use `password_verify()` to check passwords (assumes passwords stored with `password_hash()`)
2. **Prepared Statements:** All database queries must use prepared statements
3. **Session Security:** Use same secure session configuration as admin (`configureSecureSession()` from `admin/includes/security_utils.php`)
4. **Input Validation:** Validate phone format before database query
5. **CSRF Protection:** Consider adding CSRF tokens for future form submissions (not required for initial implementation)
6. **Session Timeout:** 30-minute inactivity timeout, regenerate session ID on login

---

## Error Handling

1. **Login Errors:**
   - Invalid phone format ‚Üí 400 with message
   - Customer not found ‚Üí 401 with generic "Invalid credentials" message
   - Wrong password ‚Üí 401 with generic "Invalid credentials" message
   - Database error ‚Üí 500 with logged error

2. **Profile Fetch Errors:**
   - Not authenticated ‚Üí 401, redirect to login
   - Customer not found (edge case) ‚Üí 401, clear session, redirect to login
   - Database error ‚Üí 500 with logged error

3. **Frontend Error Handling:**
   - Network failures ‚Üí Display user-friendly error message
   - 401 responses ‚Üí Clear any local storage, redirect to login
   - 500 responses ‚Üí Display generic error message, log details

---

## Files Reference Table

| File | Type | Action | Purpose |
|------|------|--------|---------|
| `user/includes/auth_check.php` | PHP | üî® Create | Customer authentication utilities |
| `api/customer/auth/login.php` | PHP | üî® Create | Customer login endpoint |
| `api/customer/profile.php` | PHP | üî® Create | Get customer profile data |
| `api/customer/auth/logout.php` | PHP | üî® Create | Customer logout endpoint |
| `user/dashboard.html` | HTML/PHP | ‚úèÔ∏è Modify | Add auth check, update structure |
| `user/dashboard.js` | JS | ‚úèÔ∏è Modify | Replace mock data with API calls |
| `js/login.js` | JS | ‚úèÔ∏è Modify | Implement real customer login |
| `admin/includes/auth_check.php` | PHP | ‚úÖ Reference | Pattern for customer auth |
| `api/admin/auth/login.php` | PHP | ‚úÖ Reference | Pattern for login endpoint |
| `config/db_connect.php` | PHP | ‚úÖ Exists | Database connection |
| `config/utils.php` | PHP | ‚úÖ Exists | Phone validation functions |
| `admin/includes/security_utils.php` | PHP | ‚úÖ Exists | Secure session configuration |

---

## Implementation Phases

### Phase 1: Authentication Infrastructure
1. Create `user/includes/auth_check.php` with customer auth functions
2. Create `api/customer/auth/login.php` endpoint
3. Update `js/login.js` to use real login API
4. Test login flow end-to-end

### Phase 2: Profile Data API
1. Create `api/customer/profile.php` endpoint
2. Test API returns correct customer data with booking stats

### Phase 3: Dashboard Integration
1. Convert `user/dashboard.html` to `user/dashboard.php` (or keep HTML and add auth redirect)
2. Update `user/dashboard.js` to fetch profile from API
3. Remove hardcoded mock data
4. Test dashboard displays real data

### Phase 4: Logout and Cleanup
1. Create `api/customer/auth/logout.php`
2. Update logout button/link to call logout endpoint
3. Test session cleanup

---

## Notes

- Follow existing admin authentication patterns for consistency
- Use same security utilities (`security_utils.php`) for session configuration
- Database connection uses `getDBConnection()` from `config/db_connect.php`
- Phone validation uses existing `sanitizePhone()` and `isValidMalaysianPhone()` functions
- All API responses should be JSON with consistent structure
- Consider future enhancements: profile editing, password change, booking history display

