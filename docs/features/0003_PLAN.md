# Business Analytics Summary Cards - Technical Plan

## Context

Implement a **Current Month Financial Summary** section for the admin Business Analytics page. This adds three key metrics displayed as clean white summary cards following the LumiÃ¨re minimal/classy design aesthetic.

**Metrics Required:**

1. **Total Revenue** - Sum of `total_price` from `booking` table for `status = 'completed'` in current month
2. **Total Commission Paid** - Sum of `quoted_price` from `booking_service` table Ã— 0.10 for completed services in current month
3. **Total Booking Volume** - Count of all bookings created in current month (regardless of status)

**Commission Rate:** Flat 10% on `quoted_price` from `booking_service` table (not `total_price` from `booking`)

---

## Database Schema Reference

### `booking` table

- `booking_id` VARCHAR(8) - Primary key
- `total_price` DECIMAL(7,2) - Total booking price
- `status` ENUM('confirmed','completed','cancelled','no_show')
- `created_at` TIMESTAMP - When booking was created

### `booking_service` table

- `booking_id` VARCHAR(8) - Foreign key to booking
- `quoted_price` DECIMAL(6,2) - Price quoted for this service
- `service_status` ENUM('confirmed','completed','cancelled')

---

## Files to Modify

| File                           | Change                                         |
| ------------------------------ | ---------------------------------------------- |
| `admin/analytics/business.php` | Add PHP logic + HTML for summary cards section |

---

## Implementation Details

### MySQL Queries (Using Prepared Statements)

**Query 1: Total Revenue (Current Month, Completed Bookings)**

```sql
SELECT COALESCE(SUM(total_price), 0) AS total_revenue
FROM booking
WHERE status = 'completed'
  AND MONTH(created_at) = MONTH(CURRENT_DATE())
  AND YEAR(created_at) = YEAR(CURRENT_DATE())
```

**Query 2: Total Commission Paid + Commission Ratio (Current Month, Completed Services)**

```sql
SELECT
    COALESCE(SUM(bs.quoted_price), 0) * 0.10 AS total_commission,
    (SUM(bs.quoted_price) * 0.10) / NULLIF(SUM(b.total_price), 0) * 100 AS commission_ratio
FROM booking_service bs
JOIN booking b ON bs.booking_id = b.booking_id
WHERE bs.service_status = 'completed'
  AND MONTH(b.created_at) = MONTH(CURRENT_DATE())
  AND YEAR(b.created_at) = YEAR(CURRENT_DATE())
```

**Query 3: Total Booking Volume (Current Month, All Statuses)**

```sql
SELECT COUNT(*) AS total_volume
FROM booking
WHERE MONTH(created_at) = MONTH(CURRENT_DATE())
  AND YEAR(created_at) = YEAR(CURRENT_DATE())
```

### PHP Implementation Algorithm

1. Include database connection via `require_once '../../config/db_connect.php'`
2. Get MySQLi connection: `$conn = getDBConnection()`
3. Execute each query using `$conn->query()` (no user input = safe without prepared statements)
4. Fetch results and store in variables: `$total_revenue`, `$total_commission`, `$total_volume`
5. Format currency values with `number_format($value, 2)`
6. Close connection: `$conn->close()`

### HTML/CSS Structure

Insert a new "Current Month Summary" section **above** the existing KPI cards section. Uses existing `.stat-card` styling from `admin-style.css` with white card layout.

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Current Month Summary                                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ğŸ’° Total       â”‚  ğŸ“Š Commission  â”‚  ğŸ“ˆ Booking             â”‚
â”‚  Revenue        â”‚  Paid           â”‚  Volume                 â”‚
â”‚  RM 12,500.00   â”‚  RM 1,250.00    â”‚  156                    â”‚
â”‚  Completed      â”‚  10% rate       â”‚  All bookings           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Card Icons:**

- Total Revenue: `fas fa-coins` (gold/brown accent)
- Commission Paid: `fas fa-hand-holding-usd` (green accent)
- Booking Volume: `fas fa-chart-line` (blue accent)

### Integration Point

Insert the new section in `business.php` after line 49 (after `<div id="analytics-content" style="display: none;">`) and before the existing KPI cards grid.

---

## Staff Leaderboard (Performance Ranking)

### Purpose

Provide a data-driven staff performance table that matches the Staff Module's ranking system. This enables admins to:

- Reward top earners
- Coach low performers
- Understand why staff members rank where they do (#1, #9, etc.)

### Query: Staff Performance Ranking

```sql
SELECT
    s.staff_id,
    CONCAT(s.first_name, ' ', s.last_name) AS full_name,
    COUNT(bs.booking_service_id) AS completed_count,
    COALESCE(SUM(bs.quoted_price), 0) AS revenue_generated,
    COALESCE(SUM(bs.quoted_price), 0) * 0.10 AS commission_earned
FROM staff s
LEFT JOIN booking_service bs ON s.staff_id = bs.staff_id
    AND bs.service_status = 'completed'
    AND MONTH(bs.created_at) = MONTH(CURRENT_DATE())
WHERE s.is_active = 1
GROUP BY s.staff_id
ORDER BY revenue_generated DESC
```

**Key Features:**

- Includes all active staff (even with 0 bookings via LEFT JOIN)
- Ranks by `revenue_generated` (determines #1, #2, etc.)
- Shows completed service count for performance context
- Calculates commission earned (10% of quoted prices)
- Filters to current month only

### Display Columns

| Rank | Staff Name | Completed Services | Revenue Generated | Commission Earned |
| ---- | ---------- | ------------------ | ----------------- | ----------------- |
| #1   | Jane Doe   | 45                 | RM 4,500.00       | RM 450.00         |
| #2   | John Smith | 38                 | RM 3,800.00       | RM 380.00         |
| ...  | ...        | ...                | ...               | ...               |

**Why This Matters:** When a staff member sees they're ranked #9 in the Staff Module, this table shows the admin exactly why (low revenue or low completed count), enabling specific management actions.

---

## Design Specifications

Following `brief.md` aesthetic:

- **Background:** White (`#ffffff`)
- **Border Radius:** `var(--border-radius)` from admin-style.css
- **Box Shadow:** `var(--card-shadow)` - subtle elevation
- **Typography:** Serif headers, clean sans-serif values
- **Colors:**
  - Revenue icon: `#c29076` (Brown - primary accent)
  - Commission icon: `#4CAF50` (Success green)
  - Volume icon: `#2196F3` (Blue)
- **Value font-size:** 32px bold
- **Label font-size:** 13px muted
