# Service Management CRUD Backend - Technical Plan

## Context

Implement complete CRUD (Create, Read, Update, Delete) backend logic for the Service Management page (`admin/manage_services.php`). The HTML/CSS UI (table view and modal form) is already designed and styled. The backend must use Native PHP and MySQLi with `require_once '../config/db_connect.php'` for database operations.

**Design Aesthetic**: Follows Lumière minimal, classy design with brown/earthy tones as specified in brief.md.

## Database Schema

**Table:** `Service`

- `service_id` (VARCHAR(4), PRIMARY KEY) - Service identifier
- `service_category` (VARCHAR) - Main category (e.g., Hair, Beauty, Massage, Nail)
- `sub_category` (VARCHAR, nullable) - Sub-category classification
- `service_name` (VARCHAR) - Full service name
- `current_duration_minutes` (INT) - Service duration in minutes
- `current_price` (DECIMAL) - Current service price
- `description` (TEXT, nullable) - Service description
- `default_cleanup_minutes` (INT) - Cleanup time after service
- `is_active` (TINYINT) - Active status flag (1 = active, 0 = inactive)
- `service_image` (VARCHAR, nullable) - Path to service image file
- `created_at` (TIMESTAMP) - Creation timestamp

## Files to Create/Modify

### Files to Create:

1. `api/admin/services/crud.php` - Unified CRUD endpoint handling POST (create), PUT (update), DELETE (delete) requests
2. `admin/manage_services.php` - Main service management page with server-side READ operation (if not exists, or update existing `admin/services/list.php`)

### Files to Modify:

1. `api/admin/services/create.php` - Update to use `require_once '../../../config/db_connect.php'` instead of `connection.php`
2. `api/admin/services/update.php` - Update to use `require_once '../../../config/db_connect.php'` instead of `connection.php`
3. `api/admin/services/delete.php` - Update to use `require_once '../../../config/db_connect.php'` instead of `connection.php`
4. `api/admin/services/list.php` - Update to use `require_once '../../../config/db_connect.php'` instead of `connection.php`
5. `admin/services/list.js` - Update API endpoint URLs if using unified `crud.php` endpoint

## Implementation Details

### Phase 1: Database Connection Standardization

**1.1 Update All Service API Endpoints**

All existing service API endpoints must be updated to use the standardized database connection:

- Replace `require_once '../../../php/connection.php'` with `require_once '../../../config/db_connect.php'`
- Replace `$conn = ...` with `$conn = getDBConnection();`
- Ensure all endpoints use the ErrorHandler class for consistent error responses
- Files to update:
  - `api/admin/services/create.php`
  - `api/admin/services/update.php`
  - `api/admin/services/delete.php`
  - `api/admin/services/list.php`
  - `api/admin/services/toggle_status.php`

### Phase 2: CREATE Operation

**2.1 Create Endpoint (`api/admin/services/create.php`)**

**Request Method:** POST

**Request Body (JSON):**
```json
{
  "csrf_token": "string",
  "service_category": "string (required, max 50 chars)",
  "sub_category": "string (optional, max 50 chars)",
  "service_name": "string (required, max 100 chars)",
  "current_duration_minutes": "integer (required, 5-480)",
  "current_price": "decimal (required, > 0)",
  "description": "string (optional)",
  "default_cleanup_minutes": "integer (required, 0-60)",
  "service_image": "string (optional, file path)",
  "is_active": "boolean (optional, default: true)"
}
```

**Validation Rules:**
- `service_category`: Required, non-empty, max 50 characters, trim whitespace
- `sub_category`: Optional, max 50 characters if provided, trim whitespace
- `service_name`: Required, non-empty, max 100 characters, trim whitespace
- `current_duration_minutes`: Required, integer, minimum 5, maximum 480, must be positive
- `current_price`: Required, numeric, greater than 0, max 99999999.99
- `description`: Optional, text field, no length limit but should be reasonable
- `default_cleanup_minutes`: Required, integer, minimum 0, maximum 60
- `service_image`: Optional, string path to image file
- `is_active`: Optional boolean, defaults to 1 (true) if not provided

**Business Logic:**
1. Validate CSRF token using `validateCSRFToken()` from `admin/includes/auth_check.php`
2. Validate all input data according to rules above
3. Check for duplicate service name within the same category (case-insensitive comparison)
4. Generate `service_id` as auto-increment (if using AUTO_INCREMENT) or generate unique 4-character code
5. Insert new service record using prepared statement
6. Return JSON response with `service_id` and success message

**SQL Query:**
```sql
INSERT INTO Service (service_category, sub_category, service_name, 
                     current_duration_minutes, current_price, description, 
                     service_image, default_cleanup_minutes, is_active)
VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?)
```

**Response (Success - 201):**
```json
{
  "success": true,
  "service_id": "integer or string",
  "message": "Service created successfully"
}
```

**Response (Error - 400/409/500):**
```json
{
  "success": false,
  "error": {
    "code": "VALIDATION_ERROR|DUPLICATE_ENTRY|DATABASE_ERROR",
    "message": "Error message",
    "details": { "field_name": "error message" }
  }
}
```

### Phase 3: READ Operation

**3.1 List Endpoint (`api/admin/services/list.php`)**

**Request Method:** GET

**Query Parameters:**
- `category` (optional): Filter by service category
- `search` (optional): Search in service_name and description
- `active_only` (optional): Boolean, filter only active services

**Business Logic:**
1. Build dynamic SQL query with optional WHERE clauses based on filters
2. Use prepared statements for all parameters
3. Order results by `service_category`, then `service_name`
4. Convert `is_active` to boolean in response
5. Convert numeric fields to appropriate types (int for duration/cleanup, float for price)

**SQL Query (Base):**
```sql
SELECT service_id, service_category, sub_category, service_name, 
       current_duration_minutes, current_price, description, 
       service_image, default_cleanup_minutes, is_active, created_at
FROM Service
WHERE 1=1
[+ category filter]
[+ search filter]
[+ active filter]
ORDER BY service_category, service_name
```

**Response (Success - 200):**
```json
{
  "success": true,
  "services": [
    {
      "service_id": "integer or string",
      "service_category": "string",
      "sub_category": "string or null",
      "service_name": "string",
      "current_duration_minutes": "integer",
      "current_price": "float",
      "description": "string or null",
      "service_image": "string or null",
      "default_cleanup_minutes": "integer",
      "is_active": "boolean",
      "created_at": "timestamp string"
    }
  ],
  "count": "integer"
}
```

**3.2 Server-Side Rendering (Optional - `admin/manage_services.php`)**

If server-side rendering is needed for initial page load:

1. Include authentication check: `require_once 'includes/auth_check.php'` and `requireAdminAuth()`
2. Include database connection: `require_once '../config/db_connect.php'`
3. Fetch all services using prepared statement
4. Pass services array to view for server-side table rendering
5. Maintain existing modal form structure for client-side create/edit

### Phase 4: UPDATE Operation

**4.1 Update Endpoint (`api/admin/services/update.php`)**

**Request Method:** PUT

**Request Body (JSON):**
```json
{
  "csrf_token": "string",
  "service_id": "integer or string (required)",
  "service_category": "string (required, max 50 chars)",
  "sub_category": "string (optional, max 50 chars)",
  "service_name": "string (required, max 100 chars)",
  "current_duration_minutes": "integer (required, 5-480)",
  "current_price": "decimal (required, > 0)",
  "description": "string (optional)",
  "default_cleanup_minutes": "integer (required, 0-60)",
  "service_image": "string (optional, file path)",
  "is_active": "boolean (optional)"
}
```

**Validation Rules:**
- Same as CREATE, plus:
- `service_id`: Required, must exist in database

**Business Logic:**
1. Validate CSRF token
2. Validate all input data
3. Check if service exists by `service_id`
4. Check for duplicate service name within same category, excluding current service
5. Update service record using prepared statement
6. Return updated service data

**SQL Query:**
```sql
UPDATE Service 
SET service_category = ?, 
    sub_category = ?, 
    service_name = ?, 
    current_duration_minutes = ?, 
    current_price = ?, 
    description = ?, 
    service_image = ?, 
    default_cleanup_minutes = ?, 
    is_active = ?
WHERE service_id = ?
```

**Response (Success - 200):**
```json
{
  "success": true,
  "service_id": "integer or string",
  "message": "Service updated successfully"
}
```

**Response (Error - 404/400/409/500):**
```json
{
  "success": false,
  "error": {
    "code": "NOT_FOUND|VALIDATION_ERROR|DUPLICATE_ENTRY|DATABASE_ERROR",
    "message": "Error message",
    "details": { "field_name": "error message" }
  }
}
```

### Phase 5: DELETE Operation

**5.1 Delete Endpoint (`api/admin/services/delete.php`)**

**Request Method:** DELETE

**Request Body (JSON):**
```json
{
  "csrf_token": "string",
  "service_id": "integer or string (required)"
}
```

**Business Logic:**
1. Validate CSRF token
2. Validate `service_id` is provided
3. Check if service exists
4. Check for existing future bookings in `Booking_Service` table:
   - Query: Count bookings where `service_id` matches, `booking_date >= CURDATE()`, and status is 'confirmed' or 'completed'
5. If future bookings exist:
   - Return error with booking count and message suggesting deactivation instead
   - HTTP 409 (Conflict)
6. If no future bookings:
   - Delete service record using prepared statement
   - Return success message

**SQL Queries:**

Check bookings:
```sql
SELECT COUNT(*) as booking_count 
FROM Booking_Service bs
INNER JOIN Booking b ON bs.booking_id = b.booking_id
WHERE bs.service_id = ? 
  AND b.booking_date >= CURDATE()
  AND b.status IN ('confirmed', 'completed')
  AND bs.service_status IN ('confirmed', 'completed')
```

Delete service:
```sql
DELETE FROM Service WHERE service_id = ?
```

**Response (Success - 200):**
```json
{
  "success": true,
  "service_id": "integer or string",
  "message": "Service deleted successfully"
}
```

**Response (Error - 404/409/500):**
```json
{
  "success": false,
  "error": {
    "code": "NOT_FOUND|HAS_FUTURE_BOOKINGS|DATABASE_ERROR",
    "message": "Error message",
    "details": {
      "booking_count": "integer (if HAS_FUTURE_BOOKINGS)",
      "service_name": "string (if HAS_FUTURE_BOOKINGS)"
    }
  }
}
```

### Phase 6: Error Handling & Security

**6.1 Error Handling Pattern**

All endpoints must:
- Use `ErrorHandler` class from `admin/includes/error_handler.php`
- Log errors using `ErrorHandler::logError()`
- Return consistent JSON error format
- Use appropriate HTTP status codes:
  - 200: Success
  - 201: Created
  - 400: Bad Request (validation errors)
  - 401: Unauthorized (authentication required)
  - 403: Forbidden (invalid CSRF token)
  - 404: Not Found
  - 409: Conflict (duplicate entry, has bookings)
  - 500: Internal Server Error

**6.2 Security Measures**

- All endpoints require admin authentication via `isAdminAuthenticated()`
- All endpoints validate CSRF token via `validateCSRFToken()`
- All endpoints check session timeout via `checkSessionTimeout()`
- All database queries use prepared statements (no string concatenation)
- Input sanitization: trim whitespace, validate types, check lengths
- SQL injection prevention: prepared statements only
- XSS prevention: output encoding handled by frontend

**6.3 Database Connection**

- Use `require_once '../../../config/db_connect.php'` (for API files)
- Use `require_once '../config/db_connect.php'` (for admin/manage_services.php)
- Call `getDBConnection()` function to get MySQLi connection
- Always close connection after operations: `$conn->close()`
- Always close prepared statements: `$stmt->close()`

## Data Flow

### Create Flow:
1. User fills form in modal → JavaScript collects data
2. JavaScript sends POST to `api/admin/services/create.php`
3. Backend validates CSRF, validates data, checks duplicates
4. Backend inserts into database
5. Backend returns success with `service_id`
6. JavaScript refreshes service list

### Read Flow:
1. Page loads → JavaScript calls GET `api/admin/services/list.php`
2. Backend queries database with optional filters
3. Backend returns JSON array of services
4. JavaScript renders table

### Update Flow:
1. User clicks edit → JavaScript populates modal with service data
2. User modifies form → JavaScript collects updated data
3. JavaScript sends PUT to `api/admin/services/update.php`
4. Backend validates CSRF, validates data, checks duplicates (excluding self)
5. Backend updates database
6. Backend returns success
7. JavaScript refreshes service list

### Delete Flow:
1. User clicks delete → JavaScript shows confirmation
2. User confirms → JavaScript sends DELETE to `api/admin/services/delete.php`
3. Backend validates CSRF, checks for future bookings
4. If bookings exist → return error with suggestion to deactivate
5. If no bookings → delete from database
6. Backend returns success or error
7. JavaScript refreshes service list or shows error

## Validation Details

### Field Validation Functions:

**service_category:**
- Required
- Trim whitespace
- Non-empty after trim
- Max length: 50 characters
- Error message: "Service category is required" or "Service category must not exceed 50 characters"

**sub_category:**
- Optional
- If provided: trim whitespace, max length 50 characters
- Error message: "Sub-category must not exceed 50 characters"

**service_name:**
- Required
- Trim whitespace
- Non-empty after trim
- Max length: 100 characters
- Error message: "Service name is required" or "Service name must not exceed 100 characters"

**current_duration_minutes:**
- Required
- Must be integer
- Minimum: 5 minutes
- Maximum: 480 minutes (8 hours)
- Error message: "Duration is required" or "Duration must be between 5 and 480 minutes"

**current_price:**
- Required
- Must be numeric (float/decimal)
- Must be greater than 0
- Maximum: 99999999.99
- Error message: "Price is required" or "Price must be greater than 0" or "Price exceeds maximum allowed value"

**default_cleanup_minutes:**
- Required
- Must be integer
- Minimum: 0
- Maximum: 60
- Error message: "Cleanup time is required" or "Cleanup time must be between 0 and 60 minutes"

**description:**
- Optional
- No length validation (handled by database TEXT type)
- Can be null or empty string

**service_image:**
- Optional
- String path to image file
- No validation in backend (handled by file upload logic separately)

**is_active:**
- Optional
- Boolean (true/false or 1/0)
- Defaults to 1 (true) if not provided

## Testing Considerations

1. **Create Tests:**
   - Valid service creation
   - Duplicate service name in same category (should fail)
   - Missing required fields (should fail)
   - Invalid duration/price values (should fail)
   - Invalid CSRF token (should fail)

2. **Read Tests:**
   - Fetch all services
   - Filter by category
   - Search by name/description
   - Filter active only
   - Empty result set handling

3. **Update Tests:**
   - Valid update
   - Update to duplicate name in same category (should fail)
   - Update non-existent service (should fail)
   - Partial update (only some fields)

4. **Delete Tests:**
   - Delete service with no bookings (should succeed)
   - Delete service with future bookings (should fail with 409)
   - Delete non-existent service (should fail with 404)

5. **Security Tests:**
   - Unauthenticated requests (should fail with 401)
   - Invalid CSRF token (should fail with 403)
   - SQL injection attempts (should be prevented by prepared statements)
   - XSS attempts (should be handled by frontend)

## Notes

- The `service_id` field is VARCHAR(4) in the database schema. If using AUTO_INCREMENT, ensure the column type supports it, or implement a custom ID generation logic (e.g., sequential 4-character codes).
- Image upload handling is separate from CRUD operations and should be handled by a dedicated file upload endpoint if needed.
- The existing `admin/services/list.php` file may need to be renamed to `admin/manage_services.php` or the backend logic should be added to the existing file based on project structure.
- All endpoints must maintain consistency with existing error handling patterns using the `ErrorHandler` class.

