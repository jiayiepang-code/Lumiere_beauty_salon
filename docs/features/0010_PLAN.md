# 0010 — Deactivate-by-Default, Guarded Delete, and Clearer Delete Warnings

Brief

- Replace the current destructive default with a safer pattern: make “Deactivate” the primary action for Staff and Service records; reserve “Delete” for items with no historical links. Add a lightweight password re‑confirmation before any delete. Rephrase the warning text so users understand the real consequences.
- Preserve analytics and historical joins without schema changes by avoiding hard deletion in normal flows.
- Original phrasing provided: “This action cannot be undone because will affect the performance analysis.” We will keep the intent but rephrase for clarity in the UI.

Scope

- Update delete confirmation modals (Staff, Service) with clearer consequences.
- Add an admin password re‑confirmation step (“reauth”) before performing delete requests.
- Default UI behavior to Deactivate; show Delete only when it is safe (no linked bookings/history), otherwise guide users to Deactivate.
- MFA is explicitly future scope; for now, require password to authorize deletion.

Relevant Files

- Staff UI: admin/staff/list.js — `openDeleteModal()`, `confirmDelete()` and any helpers rendering the delete modal/action.
- Services UI: admin/services/list.js — `openDeleteModal()`, `confirmDelete()`; admin/services/list.php — inline/fallback modal text.
- Staff API: api/admin/staff/delete.php — delete handling (soft vs hard delete).
- Service API: api/admin/services/crud.php (DELETE) and/or api/admin/services/delete.php — service deletion handling including “has bookings” logic.
- Auth helpers: admin/includes/auth_check.php — helpers to validate session and (optionally) a small check for a short‑lived reauth flag.
- New endpoint: api/admin/security/reauth.php — verifies the admin password and sets a short‑lived session flag authorizing delete.

UI Copy Requirements

- Replace the previous wording “This action cannot be undone because will affect the performance analysis.” with a clearer sentence and short consequences list.
- Staff modal wording:
  - Title: “Delete Staff Member?”
  - Body: “Are you sure you want to delete <strong>{Staff Name}</strong>?”
  - Impact line: “This action is permanent and can impact reports and linked bookings.”
  - Consequences bullets:
    - “Historical reports/leaderboards may lose attribution for this staff.”
    - “Past bookings may show missing staff details if fully removed.”
    - “Future bookings may need reassignment or cancellation.”
    - “Database links that reference this staff can break if permanently deleted.”
- Service modal wording:
  - Title: “Delete Service?”
  - Body: “Are you sure you want to permanently delete <strong>“{Service Name}”</strong>?”
  - Impact line: “This action is permanent and can impact reports and linked bookings.”
  - Consequences bullets:
    - “Revenue‑by‑service and trends may lose attribution.”
    - “Past booking lines may show missing service details if fully removed.”
    - “Future bookings (if any) must be cancelled or reassigned.”
    - “Database links that reference this service can break if permanently deleted.”

Behavior Changes — Deactivate by Default

- Staff and Service pages display “Deactivate” as the primary destructive action. Deactivate sets the record unusable for new bookings but keeps history intact.
- “Delete” appears only when the record has no historical links (safe to remove). Otherwise, the UI either hides “Delete” or shows it disabled with a tooltip explaining why Deactivate is recommended.

Safe‑to‑Delete Detection (UI/API Coordination)

- Staff: Determine safety by counting linked rows (bookings via booking_service and/or booking, and schedules via staff_schedule). If any count > 0 → not safe → show Deactivate only.
- Service: Determine safety by counting linked rows in booking_service (past and future). If any count > 0 → not safe → show Deactivate only.
- The UI may fetch a small “canDelete” flag from existing list/detail APIs or compute from data already loaded; APIs should also enforce server‑side checks to prevent accidental hard delete.

Password Re‑Confirmation (not MFA)

- Re‑confirmation is a short flow that requires the current admin to re‑enter their password before deletion; this is not MFA, but a quick step‑up.
- UX sequence:
  1. Admin clicks Delete.
  2. UI prompts for password and POSTs it (with CSRF) to api/admin/security/reauth.php.
  3. Server validates the password for the logged‑in admin and sets a short‑lived session flag (e.g., valid for ~120 seconds).
  4. UI immediately calls the delete endpoint.
  5. Delete endpoints verify the presence and freshness of the reauth flag; if missing/expired, they return `REAUTH_REQUIRED` so the UI can prompt again.

Server‑Side Enforcement

- api/admin/staff/delete.php and the service delete endpoint(s) must check the reauth flag before executing deletion logic; if absent, return a 401 with a structured error `{ code: 'REAUTH_REQUIRED' }`.
- Service delete should continue to prevent deletion when bookings exist and recommend Deactivate.
- Staff delete may continue to soft‑delete when bookings/schedules exist, but the UI will default to Deactivate so delete becomes a rare path.

Algorithm Summaries (step‑by‑step)

- Staff Deactivate
  1. Verify admin auth + CSRF.
  2. Update the staff row to mark unavailable for new bookings (existing logic via toggle_status or update endpoint).
  3. UI refreshes the list with updated status.
- Service Deactivate
  1. Verify admin auth + CSRF.
  2. Update the service row to make it unavailable for new bookings.
  3. UI refreshes the list and filters accordingly.
- Staff Delete (guarded)
  1. UI checks if safe to delete; if not safe, guide to Deactivate.
  2. Prompt for password; call reauth; on success, call staff delete endpoint.
  3. Endpoint checks reauth flag; if valid, perform existing delete logic (soft delete when linked; hard delete only if truly unlinked).
- Service Delete (guarded)
  1. UI checks if safe to delete; if not safe, guide to Deactivate.
  2. Prompt for password; call reauth; on success, call service delete endpoint.
  3. Endpoint checks reauth flag; if valid and no links, delete; otherwise reject and direct to Deactivate.

Presentation Notes (for “joins/links” explanation)

- Your database tables are linked: booking_service.staff_email → staff.staff_email and booking_service.service_id → service.service_id. Hard‑deleting staff/service can break those links for historical records, causing reports and some UIs to lose names/attribution. Deactivate avoids that by keeping the row while removing it from future use.

Phases (can be done quickly)

- Phase 1 — UI Copy + Buttons: Update modals, set Deactivate as default, conditionally show Delete.
- Phase 2 — Reauth Endpoint: Add api/admin/security/reauth.php to verify password and set a short‑lived session flag.
- Phase 3 — API Gating: Enforce reauth in staff/service delete endpoints; keep server‑side safety checks.
- Phase 4 — Optional Polishing: Small badges or tooltips explaining why Delete is unavailable (linked history), with a link to Deactivate.

Notes

- This change is intentionally designed to be implemented without database schema changes and without MFA. MFA (email/TOTP) can be added later with minimal rework by replacing the reauth step.
